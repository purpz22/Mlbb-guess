<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess The Hero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: radial-gradient(circle, #1a1c2e 0%, #000000 100%); color: white; font-family: sans-serif; height: 100vh; overflow: hidden; }
        .glass { background: rgba(18, 18, 28, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        #hero-img { width: 200px; height: 200px; object-fit: cover; border-radius: 50%; border: 4px solid #8b5cf6; transition: 0.3s; }
        .grayscale { filter: grayscale(100%); }
        .solved { border-color: #4ade80 !important; filter: none !important; box-shadow: 0 0 50px #4ade80; }
        #timer-bar { height: 5px; background: #8b5cf6; width: 0%; transition: width 0.2s linear; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- LOGIN SCREEN -->
    <div id="login-modal" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="glass p-8 text-center max-w-sm w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">ENTER NICKNAME</h2>
            <input id="ign-input" type="text" class="w-full bg-black/50 border border-white/20 p-3 rounded text-white text-center uppercase font-bold focus:outline-none focus:border-purple-500" placeholder="Type Name Here...">
            <!-- NOTE: id added, onclick removed -->
            <button id="join-btn" class="block w-full mt-4 bg-purple-600 p-3 rounded font-bold hover:bg-purple-500 transition">JOIN GAME</button>
            <p id="error-msg" class="text-red-500 text-xs mt-2 hidden">Error connecting to database.</p>
        </div>
    </div>

    <!-- MAIN GAME UI -->
    <div class="flex gap-4 w-full max-w-5xl p-5 items-start flex-wrap justify-center">
        
        <!-- Game Area -->
        <div class="flex-1 glass p-8 text-center relative overflow-hidden min-w-[300px]">
            <div class="absolute top-0 left-0 w-full bg-white/10"><div id="timer-bar"></div></div>
            <h1 class="text-4xl font-black mb-6 text-purple-200 mt-4">GUESS THE HERO</h1>
            
            <div class="flex justify-center mb-6">
                <img id="hero-img" src="https://placehold.co/200x200?text=WAITING" alt="Hero">
            </div>

            <p id="status-text" class="text-2xl font-bold text-yellow-400 min-h-[40px] animate-pulse">WAITING FOR HOST...</p>

            <div class="flex gap-2 mt-6 justify-center">
                <input id="guess-input" type="text" class="bg-black/50 border border-purple-500/50 p-3 rounded-lg w-full max-w-[250px] text-white uppercase" placeholder="HERO NAME..." disabled>
                <button id="guess-btn" class="bg-purple-600 px-6 rounded-lg font-bold hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>GUESS</button>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="w-80 glass p-5 h-[500px] overflow-hidden flex flex-col">
            <h2 class="text-xl font-bold mb-4 text-yellow-400 border-b border-white/10 pb-2">TOP SCORES</h2>
            <ul id="leaderboard" class="space-y-2 overflow-y-auto pr-2">
                <li class="text-gray-500 text-xs">Waiting for scores...</li>
            </ul>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // Import Firebase (Using exact version 10.7.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
  authDomain: "guesshero-e1180.firebaseapp.com",
  databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "guesshero-e1180",
  storageBucket: "guesshero-e1180.firebasestorage.app",
  messagingSenderId: "274899168100",
  appId: "1:274899168100:web:da9798cf93110516d8e871"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        };

        // --- GLOBAL VARIABLES ---
        let app, db, myName = "";
        let currentHeroName = "";
        let gameActive = false;

        // --- DOM ELEMENTS ---
        const el = {
            loginModal: document.getElementById('login-modal'),
            ignInput: document.getElementById('ign-input'),
            joinBtn: document.getElementById('join-btn'),
            errorMsg: document.getElementById('error-msg'),
            img: document.getElementById('hero-img'),
            status: document.getElementById('status-text'),
            guessInput: document.getElementById('guess-input'),
            guessBtn: document.getElementById('guess-btn'),
            timer: document.getElementById('timer-bar'),
            board: document.getElementById('leaderboard')
        };

        // --- INITIALIZATION ---
        try {
            // Check if user actually pasted the config
            if (!firebaseConfig.apiKey) {
                throw new Error("Missing Firebase Config! Open index.html and paste your keys.");
            }
            
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase Connected Successfully");
        } catch (error) {
            console.error("Firebase Error:", error);
            el.errorMsg.textContent = error.message;
            el.errorMsg.classList.remove('hidden');
            el.joinBtn.disabled = true;
            el.joinBtn.textContent = "CONFIG ERROR";
            el.joinBtn.classList.add('bg-red-900');
        }

        // --- FUNCTIONS ---

        // 1. Join Game Logic
        function handleJoin() {
            const name = el.ignInput.value.trim().toUpperCase();
            if(!name) {
                alert("Please enter a nickname!");
                return;
            }
            myName = name;
            el.loginModal.classList.add('hidden');
            
            // Start Listening to Database AFTER joining
            startListeners();
        }

        // 2. Database Listeners
        function startListeners() {
            if(!db) return;

            // A. Listen for Game State Changes
            onValue(ref(db, 'gameState'), (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                el.img.src = data.imgUrl || "https://placehold.co/200x200?text=READY";
                
                if(data.phase === 'ended') {
                    // Round Over
                    el.img.className = 'solved'; // Remove blur/grayscale
                    el.status.textContent = "ANSWER: " + data.currentHero;
                    el.status.classList.remove('text-green-400', 'text-yellow-400', 'animate-pulse');
                    el.status.classList.add('text-red-400');
                    gameActive = false;
                    setInputState(false);
                } else if (data.phase === 'playing') {
                    // Playing
                    el.img.className = data.isGrayscale ? 'grayscale' : '';
                    el.img.classList.remove('solved');
                    el.status.textContent = "GUESS NOW!";
                    el.status.classList.remove('text-yellow-400', 'text-red-400', 'animate-pulse');
                    el.status.classList.add('text-green-400');
                    currentHeroName = data.currentHero;
                    gameActive = true;
                    setInputState(true);
                } else {
                    // Waiting
                    el.img.className = '';
                    el.status.textContent = "WAITING FOR HOST...";
                    el.status.classList.remove('text-green-400', 'text-red-400');
                    el.status.classList.add('text-yellow-400', 'animate-pulse');
                    gameActive = false;
                    setInputState(false);
                }
            });

            // B. Listen for Timer
            onValue(ref(db, 'timer'), (snapshot) => {
                const data = snapshot.val();
                if(!data) return;
                
                // Clear any existing timer loops
                if(window.timerInterval) clearInterval(window.timerInterval);

                window.timerInterval = setInterval(() => {
                    const now = Date.now();
                    const remaining = data.endTime - now;
                    const durationMs = data.duration * 1000;
                    
                    if(remaining <= 0) {
                        el.timer.style.width = "0%";
                        clearInterval(window.timerInterval);
                    } else {
                        const pct = (remaining / durationMs) * 100;
                        el.timer.style.width = pct + "%";
                    }
                }, 100);
            });

            // C. Listen for Leaderboard
            onValue(ref(db, 'scores'), (snapshot) => {
                const scores = snapshot.val() || {};
                // Sort scores high to low
                const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]).slice(0, 50);
                
                el.board.innerHTML = "";
                if(sorted.length === 0) {
                    el.board.innerHTML = '<li class="text-gray-500 text-xs">No scores yet...</li>';
                }

                sorted.forEach(([name, score], index) => {
                    let rankColor = "text-white";
                    if(index === 0) rankColor = "text-yellow-400";
                    if(index === 1) rankColor = "text-gray-300";
                    if(index === 2) rankColor = "text-orange-400";

                    el.board.innerHTML += `
                        <li class="flex justify-between bg-white/5 p-2 rounded border border-white/5 animate-pulse">
                            <span class="${rankColor} font-bold">#${index+1} ${name}</span>
                            <span class="text-yellow-400 font-bold font-mono">${score}</span>
                        </li>
                    `;
                });
            });
        }

        // 3. Game Actions
        function setInputState(enabled) {
            el.guessInput.disabled = !enabled;
            el.guessBtn.disabled = !enabled;
            if(enabled) { 
                el.guessInput.value = ''; 
                el.guessInput.focus(); 
            }
        }

        async function submitGuess() {
            if(!gameActive) return;
            const guess = el.guessInput.value.trim().toUpperCase();
            
            if(guess === currentHeroName.toUpperCase()) {
                // Correct Guess Logic
                try {
                    // Check round ID to prevent double wins
                    const roundSnap = await get(ref(db, 'gameState/roundId'));
                    const roundId = roundSnap.val();
                    
                    const myWinRef = ref(db, `roundWinners/${roundId}/${myName}`);
                    const hasWonSnap = await get(myWinRef);

                    if(!hasWonSnap.exists()) {
                        // Mark as winner
                        await set(myWinRef, true);
                        
                        // Calculate Rank (First come first serve)
                        const allWinnersSnap = await get(ref(db, `roundWinners/${roundId}`));
                        const winnerCount = allWinnersSnap.exists() ? Object.keys(allWinnersSnap.val()).length : 1;
                        
                        let points = 1;
                        if(winnerCount === 1) points = 5;
                        else if(winnerCount === 2) points = 3;

                        // Add Score
                        const scoreRef = ref(db, `scores/${myName}`);
                        const currentScoreSnap = await get(scoreRef);
                        const newScore = (currentScoreSnap.val() || 0) + points;
                        await set(scoreRef, newScore);

                        // Visual Feedback
                        el.status.textContent = `CORRECT! (+${points})`;
                        el.guessInput.disabled = true;
                        el.guessBtn.disabled = true;
                    }
                } catch (e) {
                    console.error("Error submitting guess", e);
                }
            } else {
                // Wrong Guess
                el.guessInput.classList.add('border-red-500', 'bg-red-900/50');
                setTimeout(() => el.guessInput.classList.remove('border-red-500', 'bg-red-900/50'), 500);
            }
        }

        // --- EVENT LISTENERS ---
        // (This is the safe way to connect buttons in modules)
        el.joinBtn.addEventListener('click', handleJoin);
        el.guessBtn.addEventListener('click', submitGuess);
        
        // Enter Key Support
        el.ignInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleJoin(); });
        el.guessInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') submitGuess(); });

    </script>
</body>
</html>
