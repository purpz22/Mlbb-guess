<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess The Hero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: radial-gradient(circle at center, #1a1c2e 0%, #000000 100%); color: white; font-family: sans-serif; height: 100vh; overflow: hidden; }
        .glass { background: rgba(18, 18, 28, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        #hero-img { width: 220px; height: 220px; object-fit: cover; border-radius: 50%; border: 4px solid #8b5cf6; transition: 0.3s; }
        .grayscale { filter: grayscale(100%); }
        .solved { border-color: #4ade80 !important; filter: none !important; box-shadow: 0 0 50px #4ade80; }
        #timer-bar { height: 6px; background: #8b5cf6; width: 0%; transition: width 0.2s linear; }
        .hidden { display: none !important; }
        
        /* Button Animation */
        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex items-center justify-center relative">

    <!-- LOGIN SCREEN -->
    <div id="login-modal" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="glass p-8 text-center max-w-sm w-full mx-4">
            <h2 class="text-3xl font-black mb-6 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">GUESS HERO</h2>
            <input id="ign-input" type="text" class="w-full bg-black/50 border border-white/20 p-3 rounded text-white text-center uppercase font-bold focus:border-purple-500 outline-none" placeholder="YOUR NICKNAME">
            <button id="join-btn" class="btn-press block w-full mt-4 bg-purple-600 p-3 rounded font-bold hover:bg-purple-500 transition shadow-lg shadow-purple-900/50">JOIN GAME</button>
        </div>
    </div>

    <!-- GAME CONTAINER -->
    <div id="game-container" class="hidden flex gap-6 w-full max-w-6xl p-5 items-start flex-wrap justify-center">
        
        <!-- MAIN GAME CARD -->
        <div class="flex-1 glass p-8 text-center relative overflow-hidden min-w-[320px]">
            <div class="absolute top-0 left-0 w-full bg-white/10"><div id="timer-bar"></div></div>
            
            <div class="flex justify-center my-6">
                <img id="hero-img" src="https://placehold.co/200x200/222/fff?text=LOADING..." alt="Hero">
            </div>

            <!-- STATUS -->
            <div id="status-text" class="text-3xl font-black text-yellow-400 tracking-widest min-h-[40px] animate-pulse">
                WAITING FOR NEXT ROUND...
            </div>

            <!-- INPUT AND SUBMIT BUTTON -->
            <div class="flex flex-col sm:flex-row gap-2 mt-8 justify-center items-center">
                <input id="guess-input" type="text" class="bg-black/50 border border-purple-500/50 p-4 rounded-xl w-full max-w-[300px] text-white font-bold text-center uppercase tracking-wider outline-none focus:border-purple-400 transition" placeholder="WAITING..." disabled>
                
                <button id="submit-btn" class="btn-press bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-green-900/50 disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                    SUBMIT
                </button>
            </div>
        </div>

        <!-- LEADERBOARD -->
        <div class="w-80 glass p-5 h-[600px] flex flex-col">
            <h2 class="text-xl font-bold mb-4 text-yellow-400 border-b border-white/10 pb-2 flex justify-between">
                <span>LEADERBOARD</span>
                <span id="player-count" class="text-xs bg-white/10 px-2 rounded-full py-1 text-white">0 Players</span>
            </h2>
            <ul id="leaderboard" class="space-y-2 overflow-y-auto flex-1 pr-1 custom-scrollbar">
                <li class="text-center text-gray-500 mt-10">No scores yet...</li>
            </ul>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âœ… YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- VARS ---
        let myName = "", currentHero = "", gameActive = false;
        const el = {
            login: document.getElementById('login-modal'),
            game: document.getElementById('game-container'),
            ign: document.getElementById('ign-input'),
            joinBtn: document.getElementById('join-btn'),
            img: document.getElementById('hero-img'),
            status: document.getElementById('status-text'),
            input: document.getElementById('guess-input'),
            submit: document.getElementById('submit-btn'),
            timer: document.getElementById('timer-bar'),
            board: document.getElementById('leaderboard')
        };

        // --- JOIN ---
        el.joinBtn.onclick = () => {
            const val = el.ign.value.trim().toUpperCase();
            if(!val) return alert("Enter Nickname!");
            myName = val;
            el.login.classList.add('hidden');
            el.game.classList.remove('hidden');
            initGame();
        };
        el.ign.addEventListener('keypress', e => { if(e.key==='Enter') el.joinBtn.click(); });

        // --- GAME LISTENERS ---
        function initGame() {
            // 1. Listen to State
            onValue(ref(db, 'gameState'), snap => {
                const data = snap.val();
                if(!data) return;

                el.img.src = data.imgUrl;
                
                if(data.phase === 'playing') {
                    // NEW ROUND START
                    gameActive = true;
                    currentHero = data.currentHero;
                    
                    el.img.className = data.isGrayscale ? "grayscale" : "";
                    el.status.textContent = "GUESS THE HERO!";
                    el.status.className = "text-3xl font-black text-green-400 animate-bounce";
                    
                    el.input.disabled = false;
                    el.submit.disabled = false;
                    el.input.value = "";
                    el.input.placeholder = "TYPE HERO NAME...";
                    el.input.focus();
                } 
                else if (data.phase === 'ended') {
                    // ROUND OVER
                    gameActive = false;
                    el.img.className = "solved"; 
                    el.status.textContent = "ANSWER: " + data.currentHero;
                    el.status.className = "text-3xl font-black text-red-500";
                    
                    el.input.disabled = true;
                    el.submit.disabled = true;
                    el.input.placeholder = "ROUND OVER";
                }
            });

            // 2. Listen to Timer
            onValue(ref(db, 'timer'), snap => {
                const t = snap.val();
                if(!t) return;
                
                if(window.timerInt) clearInterval(window.timerInt);
                window.timerInt = setInterval(() => {
                    const left = t.endTime - Date.now();
                    const pct = (left / (t.duration * 1000)) * 100;
                    el.timer.style.width = (left <= 0 ? 0 : pct) + "%";
                    if(left <= 0) clearInterval(window.timerInt);
                }, 100);
            });

            // 3. Leaderboard
            onValue(ref(db, 'scores'), snap => {
                const s = snap.val() || {};
                const sorted = Object.entries(s).sort((a,b)=>b[1]-a[1]);
                document.getElementById('player-count').textContent = `${sorted.length} Players`;
                
                el.board.innerHTML = "";
                sorted.forEach(([n, score], i) => {
                    let col = i===0 ? "text-yellow-400" : (i===1 ? "text-gray-300" : (i===2 ? "text-orange-400" : "text-white"));
                    el.board.innerHTML += `
                        <li class="flex justify-between bg-white/5 p-2 rounded border border-white/5">
                            <span class="${col} font-bold">#${i+1} ${n}</span>
                            <span class="text-yellow-400 font-mono">${score}</span>
                        </li>`;
                });
            });
        }

        // --- SUBMIT GUESS LOGIC ---
        async function submitGuess() {
            if(!gameActive) return;
            const guess = el.input.value.trim().toUpperCase();

            if(guess === currentHero.toUpperCase()) {
                // 1. Get Round ID
                const roundSnap = await get(ref(db, 'gameState/roundId'));
                const roundId = roundSnap.val();
                
                // 2. Check if I already won this round
                const myWinRef = ref(db, `roundWinners/${roundId}/${myName}`);
                const myWinSnap = await get(myWinRef);
                
                if(!myWinSnap.exists()) {
                    // 3. I haven't won yet. Check how many others have won.
                    const allWinnersRef = ref(db, `roundWinners/${roundId}`);
                    const allWinnersSnap = await get(allWinnersRef);
                    
                    // Count previous winners
                    let winnerCount = 0;
                    if(allWinnersSnap.exists()) {
                        winnerCount = Object.keys(allWinnersSnap.val()).length;
                    }

                    // 4. Determine Points
                    let points = 0;
                    let rankText = "";

                    if(winnerCount === 0) {
                        points = 5; // 1st Place
                        rankText = "1ST PLACE!";
                    } else if (winnerCount === 1) {
                        points = 2; // 2nd Place
                        rankText = "2ND PLACE!";
                    } else {
                        points = 1; // 3rd or lower
                        rankText = "CORRECT!";
                    }

                    // 5. Save Win
                    await set(myWinRef, true);
                    
                    // 6. Update Total Score
                    const scoreRef = ref(db, `scores/${myName}`);
                    const curScore = (await get(scoreRef)).val() || 0;
                    await set(scoreRef, curScore + points);

                    // 7. Visual Feedback
                    el.status.textContent = `${rankText} (+${points})`;
                    el.input.disabled = true;
                    el.submit.disabled = true;
                    el.input.value = "GOT IT!";
                    el.input.className = "bg-green-900/50 border border-green-500 p-4 rounded-xl w-full max-w-[300px] text-white font-bold text-center";
                }
            } else {
                // Wrong Guess
                el.input.classList.add('border-red-500', 'bg-red-900/20');
                el.input.value = "";
                el.input.placeholder = "TRY AGAIN";
                setTimeout(()=> {
                    el.input.classList.remove('border-red-500', 'bg-red-900/20');
                    el.input.placeholder = "TYPE HERO NAME...";
                }, 500);
            }
        }

        // Attach Submit Event
        el.submit.addEventListener('click', submitGuess);
        el.input.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') submitGuess();
        });

    </script>
</body>
</html>
