<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- CRITICAL: Prevents zooming and scales correctly on phones -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guess The Hero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: radial-gradient(circle at center, #111827 0%, #000000 100%); 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Mobile-First Glass Effect */
        .glass { 
            background: rgba(20, 20, 30, 0.85); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.08); 
            border-radius: 16px; 
        }

        /* Image Styling */
        #hero-img { 
            width: 180px; height: 180px; /* Good size for mobile */
            object-fit: cover; 
            border-radius: 12px; /* Slightly rounded square looks modern */
            border: 3px solid #8b5cf6; 
            transition: 0.3s; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* Effects */
        .grayscale { filter: grayscale(100%); }
        .solved { border-color: #4ade80 !important; filter: none !important; box-shadow: 0 0 40px #4ade80; }
        
        #timer-bar { height: 4px; background: #8b5cf6; width: 0%; transition: width 0.2s linear; }
        
        /* Button Press Effect */
        .btn-press:active { transform: scale(0.96); }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 safe-area-inset">

    <!-- 1. LOGIN MODAL -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-black/95 flex items-center justify-center p-4">
        <div class="w-full max-w-sm glass p-6 text-center">
            <h1 class="text-3xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">GUESS HERO</h1>
            <p class="text-gray-400 text-sm mb-6">Enter your name to join</p>
            
            <input id="ign-input" type="text" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white text-center text-lg font-bold outline-none focus:border-purple-500 mb-4 uppercase placeholder-gray-600" placeholder="NICKNAME" autocomplete="off">
            
            <button id="join-btn" class="btn-press w-full bg-purple-600 p-4 rounded-xl font-bold text-lg shadow-lg shadow-purple-900/40">PLAY NOW</button>
        </div>
    </div>

    <!-- 2. MAIN GAME AREA -->
    <div id="game-container" class="hidden flex-col h-full w-full max-w-md mx-auto gap-4">
        
        <!-- GAME CARD -->
        <div class="glass relative overflow-hidden flex flex-col items-center p-6 flex-shrink-0">
            <!-- Timer -->
            <div class="absolute top-0 left-0 w-full bg-white/5"><div id="timer-bar"></div></div>

            <!-- Image -->
            <div class="mt-2 mb-4 relative">
                <img id="hero-img" src="https://placehold.co/180x180/222/555?text=?" alt="Hero">
            </div>

            <!-- Status -->
            <div id="status-text" class="text-2xl font-black text-yellow-400 tracking-wider text-center h-8 mb-4">
                WAITING...
            </div>

            <!-- Inputs (Stacked for Mobile) -->
            <div class="w-full flex flex-col gap-3">
                <input id="guess-input" type="text" class="w-full bg-black/40 border border-white/10 p-3 rounded-xl text-white font-bold text-center uppercase tracking-widest outline-none focus:border-purple-500 transition-colors" placeholder="WAITING..." disabled autocomplete="off">
                
                <button id="submit-btn" class="btn-press w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg disabled:opacity-50 disabled:bg-gray-700 transition" disabled>
                    SUBMIT GUESS
                </button>
            </div>
        </div>

        <!-- LEADERBOARD (Scrollable Area) -->
        <div class="glass flex-1 overflow-hidden flex flex-col p-4 min-h-0">
            <div class="flex justify-between items-center border-b border-white/10 pb-2 mb-2">
                <h3 class="font-bold text-gray-300 text-sm tracking-wider">LEADERBOARD</h3>
                <span id="player-count" class="text-xs bg-white/10 px-2 py-1 rounded text-gray-400">0 Players</span>
            </div>
            
            <ul id="leaderboard" class="overflow-y-auto space-y-2 scrollbar-hide">
                <li class="text-center text-gray-600 text-sm mt-10">Waiting for scores...</li>
            </ul>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âœ… PASTE CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- STATE ---
        let myName = "", currentHero = "", gameActive = false;
        const el = {
            login: document.getElementById('login-modal'),
            game: document.getElementById('game-container'),
            ign: document.getElementById('ign-input'),
            joinBtn: document.getElementById('join-btn'),
            img: document.getElementById('hero-img'),
            status: document.getElementById('status-text'),
            input: document.getElementById('guess-input'),
            submit: document.getElementById('submit-btn'),
            timer: document.getElementById('timer-bar'),
            board: document.getElementById('leaderboard')
        };

        // --- JOIN ---
        el.joinBtn.addEventListener('click', () => {
            const val = el.ign.value.trim().toUpperCase();
            if(!val) return alert("Please enter a name!");
            myName = val;
            el.login.classList.add('hidden');
            el.game.classList.remove('hidden');
            el.game.classList.add('flex'); // Ensure flex is applied
            initGame();
        });

        // --- GAME LOOP ---
        function initGame() {
            // 1. Game State
            onValue(ref(db, 'gameState'), snap => {
                const data = snap.val();
                if(!data) return;

                el.img.src = data.imgUrl;

                if(data.phase === 'playing') {
                    gameActive = true;
                    currentHero = data.currentHero;
                    
                    el.img.className = data.isGrayscale ? "grayscale" : "";
                    el.status.textContent = "GUESS NOW!";
                    el.status.className = "text-2xl font-black text-green-400 animate-pulse text-center mb-4";
                    
                    el.input.disabled = false;
                    el.submit.disabled = false;
                    el.input.value = "";
                    el.input.placeholder = "TYPE NAME...";
                    el.input.focus();
                    
                    // Reset Button Style
                    el.submit.className = "btn-press w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg transition";
                    el.submit.textContent = "SUBMIT GUESS";
                } 
                else if (data.phase === 'ended') {
                    gameActive = false;
                    el.img.className = "solved"; 
                    el.status.textContent = data.currentHero; // Just the name on mobile
                    el.status.className = "text-2xl font-black text-red-500 text-center mb-4";
                    
                    el.input.disabled = true;
                    el.submit.disabled = true;
                    el.input.value = "";
                    el.input.placeholder = "ROUND OVER";
                }
            });

            // 2. Timer
            onValue(ref(db, 'timer'), snap => {
                const t = snap.val();
                if(!t) return;
                
                if(window.timerInt) clearInterval(window.timerInt);
                window.timerInt = setInterval(() => {
                    const left = t.endTime - Date.now();
                    const pct = (left / (t.duration * 1000)) * 100;
                    el.timer.style.width = (left <= 0 ? 0 : pct) + "%";
                    if(left <= 0) clearInterval(window.timerInt);
                }, 100);
            });

            // 3. Leaderboard
            onValue(ref(db, 'scores'), snap => {
                const s = snap.val() || {};
                const sorted = Object.entries(s).sort((a,b)=>b[1]-a[1]);
                document.getElementById('player-count').textContent = `${sorted.length} Players`;
                
                el.board.innerHTML = "";
                sorted.forEach(([n, score], i) => {
                    let style = "text-gray-300";
                    let rankIcon = `#${i+1}`;
                    if(i===0) { style = "text-yellow-400"; rankIcon = "ðŸ¥‡"; }
                    if(i===1) { style = "text-gray-300"; rankIcon = "ðŸ¥ˆ"; }
                    if(i===2) { style = "text-orange-400"; rankIcon = "ðŸ¥‰"; }

                    el.board.innerHTML += `
                        <li class="flex justify-between items-center bg-white/5 p-3 rounded-lg border border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="font-bold w-6 text-center ${style}">${rankIcon}</span>
                                <span class="font-bold text-sm text-white truncate max-w-[120px]">${n}</span>
                            </div>
                            <span class="text-yellow-400 font-mono font-bold">${score}</span>
                        </li>`;
                });
            });
        }

        // --- SUBMIT LOGIC (5-2-1 Points) ---
        async function submitGuess() {
            if(!gameActive) return;
            const guess = el.input.value.trim().toUpperCase();

            if(guess === currentHero.toUpperCase()) {
                const roundSnap = await get(ref(db, 'gameState/roundId'));
                const roundId = roundSnap.val();
                
                // Check if I already won
                const myWinRef = ref(db, `roundWinners/${roundId}/${myName}`);
                const myWinSnap = await get(myWinRef);
                
                if(!myWinSnap.exists()) {
                    // Count previous winners for points
                    const allWinnersRef = ref(db, `roundWinners/${roundId}`);
                    const allWinnersSnap = await get(allWinnersRef);
                    const winnerCount = allWinnersSnap.exists() ? Object.keys(allWinnersSnap.val()).length : 0;

                    let points = 1;
                    if(winnerCount === 0) points = 5;
                    else if (winnerCount === 1) points = 2;

                    // Save Data
                    await set(myWinRef, true);
                    const scoreRef = ref(db, `scores/${myName}`);
                    const curScore = (await get(scoreRef)).val() || 0;
                    await set(scoreRef, curScore + points);

                    // UI Feedback
                    el.status.textContent = `CORRECT! (+${points})`;
                    el.input.disabled = true;
                    el.submit.disabled = true;
                    el.submit.textContent = "ALREADY GUESSED";
                    el.submit.className = "w-full bg-gray-700 text-gray-400 font-bold py-3 rounded-xl cursor-not-allowed";
                }
            } else {
                // Wrong animation
                el.input.classList.add('bg-red-900/50', 'border-red-500');
                setTimeout(()=> el.input.classList.remove('bg-red-900/50', 'border-red-500'), 400);
            }
        }

        el.submit.addEventListener('click', submitGuess);
        el.ign.addEventListener('keypress', e => { if(e.key==='Enter') el.joinBtn.click() });
        // Hide keyboard on enter for game input
        el.input.addEventListener('keypress', e => { 
            if(e.key==='Enter') {
                submitGuess();
                el.input.blur(); 
            }
        });

    </script>
</body>
</html>
