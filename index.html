<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, orientation=landscape">
    <title>Ultimate Guess the Hero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* --- CORE VISUALS --- */
        body {
            font-family: 'Rajdhani', sans-serif;
            background: radial-gradient(circle at center, #1a1c2e 0%, #000000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            color: #ffffff;
        }

        /* Animated Background Mesh */
        .bg-mesh {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            z-index: -1;
            opacity: 0.8;
            animation: bgPulse 10s ease-in-out infinite alternate;
        }

        @keyframes bgPulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 0.6; }
        }

        /* --- GLASSMORPHISM CONTAINERS --- */
        #game-container {
            background: rgba(18, 18, 28, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 40px rgba(124, 58, 237, 0.15), inset 0 0 20px rgba(0,0,0,0.5);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #scoreboard-container {
            background: rgba(18, 18, 28, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            transition: all 0.3s ease;
            max-height: 500px;
            overflow: hidden;
        }
        
        #scoreboard-container.collapsed {
            max-height: 60px; /* Only header visible */
        }

        /* --- IMAGE STYLING --- */
        .image-container-wrapper {
            display: flex;
            justify-content: center;
            gap: 20px; 
            margin-bottom: 20px;
            position: relative;
        }

        .image-wrapper {
            position: relative;
            width: 200px; 
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; 
            border: 4px solid rgba(139, 92, 246, 0.5); 
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #000;
        }

        /* Scanner Effect */
        .image-wrapper::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 40%, rgba(139, 92, 246, 0.6) 50%, transparent 60%);
            background-size: 100% 200%;
            animation: scanner 3s linear infinite;
            pointer-events: none;
            opacity: 0.6;
            z-index: 5;
        }
        @keyframes scanner {
            0% { background-position: 0% -100%; }
            100% { background-position: 0% 200%; }
        }

        .image-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease, filter 0.3s ease; }
        .image-wrapper.series-skin-display { border-radius: 20px; border-color: #f59e0b; }
        .image-wrapper.solved { border-color: #4ade80 !important; box-shadow: 0 0 50px #4ade80 !important; transform: scale(1.05); }

        /* Effects */
        .image-colors-disabled img { filter: grayscale(100%); }
        .image-inverted { filter: invert(100%) hue-rotate(180deg); }
        .zoom-effect { transform: scale(1.6) rotate(2deg); }
        .blur-effect { filter: blur(15px); }
        .hard-mode-active { border-color: #ef4444 !important; animation: shake 0.5s infinite; }

        /* --- INPUT BAR --- */
        .game-input-area {
            width: 100%;
            max-width: 400px;
            margin-top: 15px;
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 60;
        }
        .game-input {
            flex: 1;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: 0.3s;
        }
        .game-input:focus { border-color: #4ade80; box-shadow: 0 0 15px rgba(74, 222, 128, 0.2); }
        
        /* --- TABS --- */
        .tab-btn {
            background: transparent; border: none; color: #9ca3af; 
            padding: 5px 10px; font-size: 0.8rem; font-weight: bold; cursor: pointer;
            border-bottom: 2px solid transparent; transition: 0.2s;
        }
        .tab-btn.active { color: #f59e0b; border-bottom-color: #f59e0b; }
        .tab-btn:hover { color: white; }

        /* --- ADMIN CONTROLS --- */
        #admin-panel {
            display: none; /* Hidden by default */
        }
        #admin-panel.visible {
            display: block;
        }

        /* --- ANIMATIONS --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* Utils */
        .btn-base { font-family: 'Inter', sans-serif; font-weight: 700; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(4px); transition: 0.2s; cursor: pointer;}
        .btn-base:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .btn-secondary { background: rgba(55, 65, 81, 0.8); color: #e5e7eb; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .hidden { display: none !important; }
        
        /* Fullscreen Alerts */
        .fullscreen-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .fullscreen-overlay.visible { opacity: 1; pointer-events: auto; }

        /* Timer Bar */
        #timer-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); position: absolute; top: 0; left: 0; z-index: 20; }
        #timer-bar { height: 100%; width: 100%; background: linear-gradient(90deg, #8b5cf6, #3b82f6); transform-origin: left; transition: transform 1s linear; }
    </style>
</head>
<body class="text-gray-100">

    <div class="bg-mesh"></div>

    <div class="flex flex-wrap gap-8 justify-center items-start w-full max-w-[1400px] p-5">
        
        <!-- MAIN GAME CARD -->
        <div id="game-container" class="flex-1 min-w-[340px] max-w-[600px] p-8 text-center relative transition-transform duration-300">
            <!-- Progress Bar Timer -->
            <div id="timer-bar-container"><div id="timer-bar" style="transform: scaleX(0);"></div></div>

            <h1 class="text-5xl font-black mb-8 text-transparent bg-clip-text bg-gradient-to-r from-purple-200 to-blue-200 drop-shadow-lg">
                GUESS THE HERO
            </h1>
            
            <div class="image-container-wrapper">
                <div id="skill-image-wrapper-one" class="image-wrapper">
                    <img id="skill-icon" src="" alt="Hero" class="">
                </div>
                <div id="skill-image-wrapper-two" class="image-wrapper hidden">
                    <img id="skill-icon-two" src="" alt="Hero 2" class="">
                </div>
            </div>

            <!-- Status Text -->
            <p id="feedback" class="mt-2 text-3xl font-bold min-h-[1.5em] text-purple-200 tracking-wide"></p>
            
            <!-- INPUT BAR (Replaces WebSocket) -->
            <div class="game-input-area">
                <input type="text" id="player-input" class="game-input" placeholder="Type hero name here..." autocomplete="off">
                <button id="submit-guess-btn" class="btn-primary btn-base px-6 rounded-lg">GUESS</button>
            </div>

            <button id="skip-button" class="btn-warning btn-base mt-4 py-2 px-8 rounded-full text-sm uppercase tracking-wider shadow-lg">
                Skip Round
            </button>

            <!-- Announcements Area -->
            <div id="announcement-area" class="absolute bottom-20 w-full flex flex-col items-center pointer-events-none z-50"></div>
        </div>
        
        <!-- SCOREBOARD -->
        <div class="flex flex-col gap-5 w-full max-w-[400px]">
            <div id="scoreboard-container" class="shadow-xl relative">
                <!-- Header & Toggles -->
                <div class="flex justify-between items-center p-4 bg-white/5 border-b border-white/10">
                    <h2 class="text-xl font-bold font-['Rajdhani'] uppercase tracking-widest text-yellow-100">
                        Leaderboard
                    </h2>
                    <button id="toggle-scoreboard" class="text-xs text-gray-400 hover:text-white uppercase">[ Toggle ]</button>
                </div>

                <!-- Tabs -->
                <div class="flex gap-4 px-4 py-2 bg-black/20">
                    <button class="tab-btn active" onclick="switchTab('today')">TODAY</button>
                    <button class="tab-btn" onclick="switchTab('yesterday')">YESTERDAY</button>
                    <button class="tab-btn" onclick="switchTab('week')">WEEK</button>
                </div>

                <!-- List Content -->
                <div class="p-4">
                    <ul id="scoreboard-list" class="space-y-2 text-sm font-['Inter'] min-h-[100px]">
                        <!-- JS injects here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- OVERLAYS -->
    <div id="hard-mode-alert" class="fullscreen-overlay">
        <div class="text-center animate-bounce">
            <h2 class="text-8xl font-black text-red-500 drop-shadow-[0_0_25px_rgba(239,68,68,0.8)]">WARNING</h2>
            <p class="text-4xl text-white mt-4 font-bold tracking-[10px] uppercase">Hard Mode Incoming</p>
        </div>
    </div>

    <div id="winner-overlay" class="fullscreen-overlay">
        <div class="text-center">
            <h2 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600 mb-4">VICTORY</h2>
            <div class="text-8xl">ðŸ‘‘</div>
            <h3 id="winner-name-large" class="text-4xl font-bold text-white mt-4">Player Name</h3>
        </div>
    </div>

    <!-- ADMIN CONTROLS (Hidden by default) -->
    <div id="admin-panel">
        <div class="fixed top-2 right-2 bg-red-600/20 p-2 rounded text-xs text-red-400 font-mono border border-red-500/50">ADMIN MODE ACTIVE</div>
        
        <div class="fixed flex flex-col gap-2 z-50 bottom-5 left-5 p-2 bg-black/60 rounded-xl backdrop-blur-md border border-white/10">
            <button id="toggle-second-place-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Enable 2nd Place</button>
            <button id="toggle-third-place-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Enable 3rd Place</button>
            <button id="toggle-slowmode-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Slowmode</button>
            <div class="h-px bg-white/20 my-1"></div>
            <button id="toggle-zoom-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Zoom FX</button>
            <button id="toggle-blur-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Blur FX</button>
            <button id="toggle-change-position-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Move FX</button>
            <button id="toggle-two-images-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Two Images</button>
        </div>

        <div class="fixed flex flex-col gap-2 z-50 bottom-5 right-5 p-2 bg-black/60 rounded-xl backdrop-blur-md border border-white/10">
            <button id="toggle-countdown-btn" class="btn-primary btn-base px-3 py-1 text-xs rounded">Timer Toggle</button>
            <button id="toggle-image-color-btn" class="btn-primary btn-base px-3 py-1 text-xs rounded">Grayscale</button>
            <button id="hard-mode-btn" class="btn-danger btn-base px-3 py-1 text-xs rounded">Hard Mode</button>
            <div class="h-px bg-white/20 my-1"></div>
            <button id="show-1st-skill-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Skill 1</button>
            <button id="show-ss-skill-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Ultimate</button>
            <button id="show-icon-skill-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Icon</button>
            <button id="show-series-skins-btn" class="btn-secondary btn-base px-3 py-1 text-xs rounded">Skins</button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. CONFIGURATION & DATA ---
        
        function normalizeName(name) {
            return name.toLowerCase().replace(/[' .]/g, '-').replace(/\.+$/, '');
        }

        const uniqueHeroNames = new Set([
            "Lunox", "Luo Yi", "Zhuxin", "Chip", "Cici", "Nolan", "Arlott", "Novaria", "Joy", "Fredrinn", 
            "Julian", "Xavier", "Melissa", "Yin", "Floryn", "Edith", "Valentina", "Aamon", "Aulus", "Natan", 
            "Phoveus", "Beatrix", "Gloo", "Paquito", "Mathilda", "Yve", "Brody", "Barats", "Khaleed", "Benedetta", 
            "Atlas", "Carmilla", "Cecilion", "Silvanna", "Wanwan", "Masha", "Baxia", "Ling", "X.borg", "Terizla", 
            "Esmeralda", "Guinevere", "Granger", "Khufra", "Badang", "Faramis", "Kadita", "Minotaur", "Hanzo", 
            "Claude", "Aldous", "Selena", "Kaja", "Chang'e", "Thamuz", "Kimmy", "Belerick", "Leomord", "Vale", 
            "Hanabi", "Uranus", "Martis", "Valir", "Gusion", "Angela", "Jawhead", "Lesley", "Pharsa", "Helcurt", 
            "Zhask", "Hylos", "Diggie", "Lancelot", "Odette", "Argus", "Grock", "Irithel", "Harley", "Gatotkaca", 
            "Roger", "Vexana", "Lapu-Lapu", "Aurora", "Hilda", "Estes", "Cyclops", "Johnson", "Moskov", 
            "Yi Sun shin", "Ruby", "Alpha", "Sun", "Chou", "Kagura", "Natalia", "Gord", "Freya", "Hayabusa", 
            "Lolita", "Layla", "Zilong", "Eudora", "Rafaela", "Clint", "Bruno", "Bane", "Franco", "Akai", "Karina", 
            "Alucard", "Miya", "Saber", "Balmond", "Nana", "Alice", "Zetian"
        ]);

        const allSkinSeriesTypes = [ "kof1", "kof2", "V.E.N.O.M", "S.A.B.E.R", "Zodiac", "Transformers", "Aspirants" ]; // (Shortened for brevity)

        // Placeholder for the icons structure. Ensure you have the 'icons' folder with images.
        const predefinedSeriesSkins = [
            { "name": "Chou", "skill_type": "kof1", "icon_path": "icons/chou-kof1.png" },
            { "name": "Gusion", "skill_type": "kof2", "icon_path": "icons/gusion-KOF2.png" }
        ];
        
        // --- 2. GAME STATE & VARIABLES ---
        
        const heroes = [];
        uniqueHeroNames.forEach(heroName => {
            if (heroName === "Fanny") return;
            const baseName = normalizeName(heroName);
            // Assuming image paths exist
            heroes.push({ "name": heroName, "skill_type": "ss", "icon_path": `icons/${baseName}-ss.webp` });
            heroes.push({ "name": heroName, "skill_type": "1st", "icon_path": `icons/${baseName}-1st.png` });
            heroes.push({ "name": heroName, "skill_type": "icon", "icon_path": `icons/${baseName}-icon.webp` });
        });
        predefinedSeriesSkins.forEach(skin => { if (skin.name !== "Fanny") heroes.push(skin); });

        const el = {
            skillIcon: document.getElementById('skill-icon'),
            skillIconTwo: document.getElementById('skill-icon-two'),
            wrapperOne: document.getElementById('skill-image-wrapper-one'),
            wrapperTwo: document.getElementById('skill-image-wrapper-two'),
            feedback: document.getElementById('feedback'),
            timerBar: document.getElementById('timer-bar'),
            announcement: document.getElementById('announcement-area'),
            scoreboardList: document.getElementById('scoreboard-list'),
            scoreboardContainer: document.getElementById('scoreboard-container'),
            hardModeAlert: document.getElementById('hard-mode-alert'),
            winnerOverlay: document.getElementById('winner-overlay'),
            winnerNameLarge: document.getElementById('winner-name-large'),
            input: document.getElementById('player-input'),
            submitBtn: document.getElementById('submit-guess-btn'),
            adminPanel: document.getElementById('admin-panel')
        };

        // State
        let currentPlayerName = "Guest";
        let activeTab = 'today';
        
        // Data Structure for Scoreboard
        let scoreData = {
            date: "", // Date of 'today'
            today: {}, // Map-like object { "User": { score: 10, streak: 2 } }
            yesterday: {},
            week: {} // Accumulator
        };

        let currentSkillData, currentSkillDataTwo;
        let winnersThisRound = [];
        let isRoundOver = false, canAcceptAnswers = false;
        let isHardModeNext = false, isCurrentRoundHard = false;
        let selectedSkillTypes = new Set(['icon']);
        let zoomBlurInterval;
        let countdownInterval;
        
        const settings = {
            countdown: true, grayscale: true, secondPlace: false, thirdPlace: false,
            slowmode: false, zoom: false, blur: false, move: false, twoImages: false
        };

        // --- 3. SCOREBOARD LOGIC ---

        function getTodayDateString() { return new Date().toISOString().slice(0, 10); }

        function loadScoreboard() {
            const todayStr = getTodayDateString();
            const stored = JSON.parse(localStorage.getItem('mlbb_full_scores') || 'null');

            if (stored) {
                // Check if date changed
                if (stored.date !== todayStr) {
                    // It's a new day! Move Today -> Yesterday
                    scoreData.yesterday = stored.today;
                    scoreData.today = {}; // Reset today
                    scoreData.week = stored.week; // Keep week
                    scoreData.date = todayStr;
                } else {
                    scoreData = stored;
                }
            } else {
                scoreData.date = todayStr;
            }
            saveScoreboard();
            renderScoreboard();
        }

        function saveScoreboard() {
            localStorage.setItem('mlbb_full_scores', JSON.stringify(scoreData));
        }

        function addScore(username, points) {
            // Update Today
            if (!scoreData.today[username]) scoreData.today[username] = { score: 0, streak: 0 };
            scoreData.today[username].score += points;
            scoreData.today[username].streak = (points >= 1) ? scoreData.today[username].streak + 1 : 0; // Only streak on 1st place

            // Update Week
            if (!scoreData.week[username]) scoreData.week[username] = { score: 0 };
            scoreData.week[username].score += points;

            saveScoreboard();
            renderScoreboard();
        }

        function renderScoreboard() {
            el.scoreboardList.innerHTML = '';
            
            let dataMap = {};
            if (activeTab === 'today') dataMap = scoreData.today;
            else if (activeTab === 'yesterday') dataMap = scoreData.yesterday;
            else if (activeTab === 'week') dataMap = scoreData.week;

            // Convert to array and sort
            const sorted = Object.entries(dataMap)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 5); // TOP 5 ONLY

            if (sorted.length === 0) {
                el.scoreboardList.innerHTML = '<li class="text-gray-500 text-center italic mt-4">No scores yet...</li>';
                return;
            }

            sorted.forEach((p, i) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-white/5 p-2 rounded border border-white/5 animate-[slideUpFade_0.3s_ease]";
                let rankColor = i === 0 ? "text-yellow-400" : (i === 1 ? "text-gray-300" : (i === 2 ? "text-orange-400" : "text-gray-400"));
                
                li.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="font-bold ${rankColor} w-6">${i+1}.</span>
                        <span class="font-semibold text-gray-200 truncate">${p.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-yellow-400 font-mono font-bold">${p.score}</span>
                        ${activeTab === 'today' && p.streak > 1 ? `<span class="text-[10px] bg-red-600 px-1 rounded">ðŸ”¥${p.streak}</span>` : ''}
                    </div>
                `;
                el.scoreboardList.appendChild(li);
            });
        }

        window.switchTab = (tab) => {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            // Very simple selector check based on text for this demo
            const btns = document.querySelectorAll('.tab-btn');
            if(tab === 'today') btns[0].classList.add('active');
            if(tab === 'yesterday') btns[1].classList.add('active');
            if(tab === 'week') btns[2].classList.add('active');
            renderScoreboard();
        };

        // --- 4. GAME LOOP ---

        function updateButtons() {
            // Helper to set button style
            const setBtn = (id, active) => {
                const b = document.getElementById(id);
                if(b) b.className = `btn-base px-3 py-1 text-xs rounded ${active ? 'btn-info' : 'btn-secondary'}`;
            };
            
            // Apply settings to UI
            setBtn('toggle-second-place-btn', settings.secondPlace);
            setBtn('toggle-third-place-btn', settings.thirdPlace);
            setBtn('toggle-slowmode-btn', settings.slowmode);
            setBtn('toggle-zoom-btn', settings.zoom);
            setBtn('toggle-blur-btn', settings.blur);
            setBtn('toggle-change-position-btn', settings.move);
            setBtn('toggle-two-images-btn', settings.twoImages);
            setBtn('toggle-countdown-btn', settings.countdown);
            
            const grayBtn = document.getElementById('toggle-image-color-btn');
            if(grayBtn) grayBtn.className = `btn-base px-3 py-1 text-xs rounded ${settings.grayscale ? 'btn-primary' : 'btn-secondary'}`;
            
            const hardBtn = document.getElementById('hard-mode-btn');
            if(hardBtn) {
                hardBtn.className = `btn-base px-3 py-1 text-xs rounded ${isHardModeNext ? 'btn-danger animate-pulse' : 'btn-secondary'}`;
                hardBtn.textContent = isHardModeNext ? "HARD MODE NEXT!" : "Hard Mode";
            }
            
            // Skill buttons
            setBtn('show-1st-skill-btn', selectedSkillTypes.has('1st'));
            setBtn('show-ss-skill-btn', selectedSkillTypes.has('ss'));
            setBtn('show-icon-skill-btn', selectedSkillTypes.has('icon'));
            const anySeries = allSkinSeriesTypes.some(t => selectedSkillTypes.has(t));
            setBtn('show-series-skins-btn', anySeries);
        }

        function loadRandomSkill() {
            isRoundOver = false;
            winnersThisRound = [];
            canAcceptAnswers = false;
            clearInterval(zoomBlurInterval);
            el.announcement.innerHTML = '';
            el.wrapperOne.classList.remove('solved');
            el.wrapperTwo.classList.remove('solved');
            el.input.value = '';
            el.input.focus();
            
            isCurrentRoundHard = isHardModeNext;
            isHardModeNext = false;
            updateButtons();

            // FX Cleanup
            const wrappers = [el.wrapperOne, el.wrapperTwo];
            const imgs = [el.skillIcon, el.skillIconTwo];
            
            wrappers.forEach(w => {
                w.className = `image-wrapper ${isCurrentRoundHard ? 'hard-mode-active' : ''}`;
            });
            imgs.forEach(i => {
                i.className = isCurrentRoundHard ? 'image-inverted' : '';
                i.style.transform = '';
                i.style.filter = settings.grayscale && !isCurrentRoundHard ? 'grayscale(100%)' : (isCurrentRoundHard ? 'invert(100%) hue-rotate(180deg)' : '');
            });

            // Filter Heroes
            let pool = heroes;
            if (selectedSkillTypes.size > 0) {
                pool = heroes.filter(h => selectedSkillTypes.has(h.skill_type));
            }
            if (pool.length === 0) { el.feedback.textContent = "No heroes found!"; return; }

            // Pick Hero 1
            const r1 = Math.floor(Math.random() * pool.length);
            currentSkillData = pool[r1];
            el.skillIcon.src = currentSkillData.icon_path;
            
            if (allSkinSeriesTypes.includes(currentSkillData.skill_type)) {
                el.wrapperOne.classList.add('series-skin-display');
            }

            // Pick Hero 2
            if (settings.twoImages) {
                el.wrapperTwo.classList.remove('hidden');
                let r2;
                do { r2 = Math.floor(Math.random() * pool.length); } while (r2 === r1);
                currentSkillDataTwo = pool[r2];
                el.skillIconTwo.src = currentSkillDataTwo.icon_path;
                if (allSkinSeriesTypes.includes(currentSkillDataTwo.skill_type)) {
                    el.wrapperTwo.classList.add('series-skin-display');
                }
            } else {
                el.wrapperTwo.classList.add('hidden');
                currentSkillDataTwo = null;
            }

            el.feedback.textContent = isCurrentRoundHard ? "HARD MODE ACTIVATED" : "SEARCHING DATABASE...";
            el.feedback.className = isCurrentRoundHard ? "mt-4 text-3xl font-black text-red-500 animate-pulse" : "mt-4 text-3xl font-bold text-purple-200 tracking-wide";

            // Visual FX Interval
            if (settings.zoom || settings.blur || settings.move) {
                zoomBlurInterval = setInterval(() => {
                    imgs.forEach(img => {
                        if (settings.zoom) img.classList.add('zoom-effect');
                        if (settings.blur) img.classList.add('blur-effect');
                        if (settings.move) img.style.transform = `translateY(${(Math.random()-0.5)*40}px)`;
                        setTimeout(() => {
                            img.classList.remove('zoom-effect', 'blur-effect');
                            img.style.transform = '';
                        }, 1500);
                    });
                }, 4000);
            }

            startTimerBar(settings.countdown ? 5 : 0);
        }

        function startTimerBar(seconds) {
            clearInterval(countdownInterval);
            el.timerBar.style.transition = 'none';
            el.timerBar.style.transform = 'scaleX(1)';
            
            if (!settings.countdown) {
                canAcceptAnswers = true;
                el.feedback.textContent = "GUESS THE HERO";
                return;
            }

            // Force reflow
            void el.timerBar.offsetWidth;
            el.timerBar.style.transition = `transform ${seconds}s linear`;
            el.timerBar.style.transform = 'scaleX(0)';

            let count = seconds;
            el.feedback.textContent = `REVEALING IN ${count}...`;
            
            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    el.feedback.textContent = `REVEALING IN ${count}...`;
                } else {
                    clearInterval(countdownInterval);
                    canAcceptAnswers = true;
                    el.feedback.textContent = "GUESS NOW!";
                    el.feedback.classList.add('text-green-400');
                    if (isCurrentRoundHard) setTimeout(() => { if(!isRoundOver) endRound(false); }, 10000);
                }
            }, 1000);
        }

        function endRound(wasWon) {
            isRoundOver = true;
            canAcceptAnswers = false;
            clearInterval(zoomBlurInterval);
            clearInterval(countdownInterval);

            el.skillIcon.style.filter = 'none';
            el.wrapperOne.classList.add('solved');
            if (settings.twoImages) {
                el.skillIconTwo.style.filter = 'none';
                el.wrapperTwo.classList.add('solved');
            }

            if (!wasWon) {
                el.feedback.textContent = `It was ${currentSkillData.name}`;
                el.feedback.className = "mt-4 text-3xl font-bold text-red-400";
            } else {
                el.feedback.textContent = "ROUND COMPLETE";
                el.feedback.className = "mt-4 text-3xl font-bold text-green-400";
            }

            const delay = wasWon && isCurrentRoundHard ? 5000 : 3500;
            isCurrentRoundHard = false;
            setTimeout(loadRandomSkill, delay);
        }

        function announceWinner(name, rank) {
            const div = document.createElement('div');
            div.className = "bg-black/90 border-2 rounded-full px-6 py-2 mb-2 flex items-center gap-3 animate-[slideUpFade_0.5s_ease]";
            div.style.borderColor = rank === 1 ? '#eab308' : (rank === 2 ? '#9ca3af' : '#fb923c');
            div.innerHTML = `<span class="text-xl">${rank===1?'ðŸ¥‡':(rank===2?'ðŸ¥ˆ':'ðŸ¥‰')}</span> <span class="font-bold text-white text-lg">${name}</span>`;
            el.announcement.appendChild(div);
            if (rank === 1) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        // --- 5. LOGIC & INPUT HANDLING ---

        function handleGuess() {
            const text = el.input.value.trim().toLowerCase();
            if (!text || isRoundOver || !canAcceptAnswers) return;

            const correct1 = currentSkillData.name.toLowerCase();
            let isCorrect = false;

            if (settings.twoImages) {
                const correct2 = currentSkillDataTwo.name.toLowerCase();
                if (text.includes(correct1) && text.includes(correct2)) isCorrect = true;
            } else {
                if (text === correct1) isCorrect = true;
            }

            if (isCorrect) {
                const maxWinners = 1 + (settings.secondPlace ? 1 : 0) + (settings.thirdPlace ? 1 : 0);
                
                if (winnersThisRound.some(w => w.name === currentPlayerName)) {
                    // Already guessed it
                    el.input.value = "Already guessed!";
                    return;
                }

                winnersThisRound.push({ name: currentPlayerName });
                const rank = winnersThisRound.length;
                let points = rank === 1 ? 1 : (rank === 2 ? 0.5 : 0.25);
                
                if (rank === 1 && isCurrentRoundHard) {
                    points += 2;
                    el.winnerNameLarge.textContent = currentPlayerName;
                    el.winnerOverlay.classList.add('visible');
                    setTimeout(() => el.winnerOverlay.classList.remove('visible'), 3000);
                }

                addScore(currentPlayerName, points);
                announceWinner(currentPlayerName, rank);
                el.input.value = ""; // Clear input

                if (winnersThisRound.length >= maxWinners) {
                    endRound(true);
                }
            } else {
                // Wrong guess visual feedback
                el.input.style.borderColor = "red";
                setTimeout(() => el.input.style.borderColor = "rgba(139, 92, 246, 0.5)", 500);
            }
        }

        // Listeners for Input
        el.submitBtn.addEventListener('click', handleGuess);
        el.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleGuess();
        });

        // --- 6. ADMIN & UTILS ---

        // Check for Admin URL Param or Shortcut
        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('admin')) {
                el.adminPanel.classList.add('visible');
            }
        }

        // Keyboard Shortcut: Ctrl + Shift + A to toggle admin
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a') {
                el.adminPanel.classList.toggle('visible');
            }
        });

        // Toggle Scoreboard
        document.getElementById('toggle-scoreboard').onclick = () => {
            el.scoreboardContainer.classList.toggle('collapsed');
        };

        // UI Event Binding (Settings)
        const bindToggle = (id, key) => {
            const btn = document.getElementById(id);
            if(btn) btn.onclick = () => {
                settings[key] = !settings[key];
                updateButtons();
                if(key==='twoImages' || key==='grayscale') loadRandomSkill();
            }
        };

        bindToggle('toggle-second-place-btn', 'secondPlace');
        bindToggle('toggle-third-place-btn', 'thirdPlace');
        bindToggle('toggle-slowmode-btn', 'slowmode');
        bindToggle('toggle-zoom-btn', 'zoom');
        bindToggle('toggle-blur-btn', 'blur');
        bindToggle('toggle-change-position-btn', 'move');
        bindToggle('toggle-two-images-btn', 'twoImages');
        bindToggle('toggle-countdown-btn', 'countdown');
        bindToggle('toggle-image-color-btn', 'grayscale');

        // Logic Buttons
        document.getElementById('skip-button').onclick = () => endRound(false);
        document.getElementById('hard-mode-btn').onclick = () => {
            isHardModeNext = true; updateButtons();
            el.hardModeAlert.classList.add('visible');
            setTimeout(() => el.hardModeAlert.classList.remove('visible'), 2000);
        };

        // Skill Filter Listeners
        const skillToggle = (type) => {
            if (selectedSkillTypes.has(type)) selectedSkillTypes.delete(type);
            else selectedSkillTypes.add(type);
            updateButtons(); loadRandomSkill();
        };
        document.getElementById('show-1st-skill-btn').onclick = () => skillToggle('1st');
        document.getElementById('show-ss-skill-btn').onclick = () => skillToggle('ss');
        document.getElementById('show-icon-skill-btn').onclick = () => skillToggle('icon');
        document.getElementById('show-series-skins-btn').onclick = () => {
            const hasAny = allSkinSeriesTypes.some(t => selectedSkillTypes.has(t));
            if(hasAny) allSkinSeriesTypes.forEach(t => selectedSkillTypes.delete(t));
            else allSkinSeriesTypes.forEach(t => selectedSkillTypes.add(t));
            updateButtons(); loadRandomSkill();
        };

        // --- INIT ---
        window.onload = () => {
            // Prompt for name
            const savedName = localStorage.getItem('mlbb_player_name');
            const nameInput = prompt("Enter your nickname to play:", savedName || "Guest");
            currentPlayerName = (nameInput && nameInput.trim() !== "") ? nameInput.substring(0, 12) : "Guest";
            localStorage.setItem('mlbb_player_name', currentPlayerName);

            checkAdminAccess();
            loadScoreboard();
            updateButtons();
            loadRandomSkill();
        };

    </script>
</body>
</html>
