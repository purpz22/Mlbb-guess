<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .hidden { display: none !important; }
        .scan-line { width: 100%; height: 2px; background: rgba(0,255,0,0.3); position: absolute; animation: scan 3s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .toggle-btn {
            background: rgba(55, 65, 81, 0.8);
            color: #e5e7eb;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
            cursor: pointer;
        }
        .toggle-btn.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-color: #8b5cf6;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }
    </style>
</head>
<body class="relative overflow-hidden">
    <div class="scan-line"></div>

    <!-- üîí 1. LOCK SCREEN -->
    <div id="login-screen" class="w-full max-w-md border border-green-800 p-8 bg-black rounded shadow-[0_0_30px_rgba(0,255,0,0.1)] text-center">
        <h1 class="text-3xl font-bold mb-6 text-red-500 tracking-widest">RESTRICTED ACCESS</h1>
        <div class="mb-4 text-xs text-gray-500">AUTHENTICATION REQUIRED</div>
        
        <input type="password" id="password-input" 
            class="w-full bg-gray-900 border border-green-700 p-4 text-center text-white text-xl outline-none focus:border-green-400 mb-4 rounded" 
            placeholder="ENTER PASSWORD">
        
        <button onclick="attemptLogin()" 
            class="w-full bg-green-900 hover:bg-green-700 text-white font-bold py-3 rounded border border-green-600 transition-all">
            UNLOCK CONSOLE
        </button>
        <div id="login-msg" class="text-red-500 mt-4 text-sm min-h-[20px]"></div>
    </div>

    <!-- üéõÔ∏è 2. CONTROL PANEL (Hidden by default) -->
    <div id="control-panel" class="hidden w-full max-w-3xl border border-green-900 p-6 rounded bg-gray-900 shadow-2xl">
        <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white">SERVER CONTROL</h1>
                <div class="text-gray-500 text-xs mt-1">Database: Asia-Southeast1 (Connected)</div>
            </div>
            <div class="text-xs text-green-500 border border-green-500 px-2 py-1 rounded">ADMIN ACTIVE</div>
        </div>
        
        <!-- STATUS BOX -->
        <div id="status-box" class="bg-black p-6 mb-6 text-center border-2 border-green-600 rounded-lg shadow-[0_0_20px_rgba(0,255,0,0.2)]">
            <h2 id="status-title" class="text-2xl font-bold text-white mb-2">SYSTEM STANDBY</h2>
            <div id="status-detail" class="text-green-400">Waiting for command...</div>
            <div id="countdown" class="text-4xl font-bold text-yellow-500 mt-4 h-10"></div>
        </div>

        <!-- MAIN CONTROLS -->
        <button id="btn-auto" onclick="toggleAuto()" class="w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all shadow-lg">
            ‚ñ∂ START AUTO-LOOP
        </button>

        <!-- GAME OPTIONS -->
        <div class="mb-6 border border-gray-700 p-4 rounded-lg bg-gray-800">
            <h3 class="text-lg font-bold text-blue-400 mb-3">GAME OPTIONS</h3>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <!-- Grayscale Toggle -->
                <button id="toggle-grayscale" class="toggle-btn py-2 px-3 rounded" onclick="toggleOption('grayscale')">
                    Show Grayscale: ON
                </button>
                <!-- Hard Mode Toggle -->
                <button id="toggle-hardmode" class="toggle-btn py-2 px-3 rounded" onclick="toggleOption('hardmode')">
                    Hard Mode: OFF
                </button>
            </div>
            
            <h4 class="text-md font-bold text-purple-300 mt-5 mb-2">IMAGE TYPES</h4>
            <div class="grid grid-cols-3 gap-3 text-sm">
                <button id="toggle-icon" class="toggle-btn active py-2 px-3 rounded" onclick="toggleSkillType('icon')">
                    Icons
                </button>
                <button id="toggle-1st" class="toggle-btn py-2 px-3 rounded" onclick="toggleSkillType('1st')">
                    1st Skill
                </button>
                <button id="toggle-ss" class="toggle-btn py-2 px-3 rounded" onclick="toggleSkillType('ss')">
                    Ultimate Skill
                </button>
                <button id="toggle-series" class="toggle-btn py-2 px-3 rounded" onclick="toggleSkillType('series')">
                    Series Skins
                </button>
            </div>
        </div>


        <div class="grid grid-cols-2 gap-4">
             <button onclick="skipRound()" class="bg-yellow-900/40 text-yellow-200 border border-yellow-700 py-3 rounded hover:bg-yellow-900/80 transition">Skip / Force Next</button>
             <button onclick="resetData()" class="bg-red-900/40 text-red-200 border border-red-700 py-3 rounded hover:bg-red-900/80 transition">Reset Leaderboard</button>
        </div>

        <!-- LOGS -->
        <div class="mt-6 pt-4 border-t border-gray-800">
            <div class="text-xs text-gray-500 mb-2">ASSET LIBRARY STATUS:</div>
            <div id="library-count" class="text-white font-bold animate-pulse">Initializing...</div>
            <div class="text-xs text-gray-600 mt-4">
                ‚ö†Ô∏è KEEP THIS TAB OPEN. This page is the "Brain" of the game.
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‚úÖ YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- AUTHENTICATION ---
        window.attemptLogin = function() {
            const pass = document.getElementById('password-input').value;
            const msg = document.getElementById('login-msg');
            
            const ADMIN_PASSWORD = "admin123"; // üîë CHANGE THIS PASSWORD
            
            if(pass === ADMIN_PASSWORD) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('control-panel').classList.remove('hidden');
                initAdminPanel(); // Initialize game logic after login
            } else {
                msg.textContent = "ACCESS DENIED: INVALID PASSWORD";
                document.getElementById('password-input').value = "";
                document.getElementById('password-input').classList.add('border-red-500');
                setTimeout(() => { msg.textContent = ""; document.getElementById('password-input').classList.remove('border-red-500'); }, 2000);
            }
        };
        document.getElementById('password-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') attemptLogin(); });


        // --- HERO ASSET GENERATION ---
        function normalizeName(name) {
            return name.toLowerCase().replace(/[' .]/g, '-').replace(/\.+$/, '');
        }

        const uniqueHeroNames = new Set([
            "Lunox", "Luo Yi", "Zhuxin", "Chip", "Cici", "Nolan", "Arlott", "Novaria", "Joy", "Fredrinn", 
            "Julian", "Xavier", "Melissa", "Yin", "Floryn", "Edith", "Valentina", "Aamon", "Aulus", "Natan", 
            "Phoveus", "Beatrix", "Gloo", "Paquito", "Mathilda", "Yve", "Brody", "Barats", "Khaleed", "Benedetta", 
            "Atlas", "Carmilla", "Cecilion", "Silvanna", "Wanwan", "Masha", "Baxia", "Ling", "X.borg", "Terizla", 
            "Esmeralda", "Guinevere", "Granger", "Khufra", "Badang", "Faramis", "Kadita", "Minotaur", "Hanzo", 
            "Claude", "Aldous", "Selena", "Kaja", "Chang'e", "Thamuz", "Kimmy", "Belerick", "Leomord", "Vale", 
            "Hanabi", "Uranus", "Martis", "Valir", "Gusion", "Angela", "Jawhead", "Lesley", "Pharsa", "Helcurt", 
            "Zhask", "Hylos", "Diggie", "Lancelot", "Odette", "Argus", "Grock", "Irithel", "Harley", "Gatotkaca", 
            "Roger", "Vexana", "Lapu-Lapu", "Aurora", "Hilda", "Estes", "Cyclops", "Johnson", "Moskov", 
            "Yi Sun shin", "Ruby", "Alpha", "Sun", "Chou", "Kagura", "Natalia", "Gord", "Freya", "Hayabusa", 
            "Lolita", "Layla", "Zilong", "Eudora", "Rafaela", "Clint", "Bruno", "Bane", "Franco", "Akai", "Karina", 
            "Alucard", "Miya", "Saber", "Balmond", "Nana", "Alice", "Zetian"
        ]);

        // Define your series skin types (used for filtering and styling)
        const allSeriesTypes = ["kof1", "kof2", "V.E.N.O.M", "S.A.B.E.R", "Zodiac", "Transformers", "Aspirants", "lightborn", "dragon-tamer"];

        // Manually list your predefined series skins here (if not following standard naming)
        const predefinedSeriesSkins = [
            { "name": "Chou", "skill_type": "kof1", "icon_path": "icons/chou-kof1.png" },
            { "name": "Gusion", "skill_type": "kof2", "icon_path": "icons/gusion-KOF2.png" },
            { "name": "Guinevere", "skill_type": "kof1", "icon_path": "icons/guinevere-kof1.png" },
            { "name": "Karina", "skill_type": "kof1", "icon_path": "icons/karina-kof1.png" },
            { "name": "Saber", "skill_type": "S.A.B.E.R", "icon_path": "icons/saber-saber.png" }, // Example S.A.B.E.R
            { "name": "Lunox", "skill_type": "Zodiac", "icon_path": "icons/lunox-zodiac.png" }, // Example Zodiac
            { "name": "Granger", "skill_type": "Lightborn", "icon_path": "icons/granger-lightborn.png" }, // Example Lightborn
            // Add more as needed
        ];

        let HERO_POOL = []; // This will contain ALL possible images

        function generateHeroPool() {
            HERO_POOL = [];
            
            uniqueHeroNames.forEach(heroName => {
                if (heroName === "Fanny") return; // Skip Fanny
                const baseName = normalizeName(heroName);
                
                // Add Ultimate (SS)
                HERO_POOL.push({ name: heroName, type: "ss", img: `icons/${baseName}-ss.webp`, isSeries: false });
                
                // Add 1st Skill
                HERO_POOL.push({ name: heroName, type: "1st", img: `icons/${baseName}-1st.png`, isSeries: false });
                
                // Add Icon
                HERO_POOL.push({ name: heroName, type: "icon", img: `icons/${baseName}-icon.webp`, isSeries: false });
            });

            // Add Special Skins (and mark them as series skins)
            predefinedSeriesSkins.forEach(skin => {
                HERO_POOL.push({ name: skin.name, type: skin.skill_type, img: skin.icon_path, isSeries: true });
            });

            document.getElementById('library-count').textContent = `Loaded ${HERO_POOL.length} unique images.`;
            document.getElementById('library-count').classList.remove('animate-pulse');
        }

        // --- GAME STATE & OPTIONS ---
        let isRunning = false;
        let loopTimer;
        let countdownInterval;

        // Default options (synced with UI state)
        let gameOptions = {
            isGrayscale: true,
            isHardMode: false,
            activeSkillTypes: {
                icon: true,
                '1st': false,
                ss: false,
                series: false // Represents all series skins
            }
        };

        // Initialize Admin Panel UI and load assets
        function initAdminPanel() {
            generateHeroPool();
            updateOptionUI(); // Set button states based on initial gameOptions
        }

        // --- OPTION TOGGLE FUNCTIONS ---
        window.toggleOption = (optionKey) => {
            gameOptions[optionKey] = !gameOptions[optionKey];
            updateOptionUI();
        };

        window.toggleSkillType = (typeKey) => {
            gameOptions.activeSkillTypes[typeKey] = !gameOptions.activeSkillTypes[typeKey];
            updateOptionUI();
        };

        // Update the UI buttons to reflect current gameOptions
        function updateOptionUI() {
            // Grayscale
            const grayBtn = document.getElementById('toggle-grayscale');
            grayBtn.className = `toggle-btn py-2 px-3 rounded ${gameOptions.isGrayscale ? 'active' : ''}`;
            grayBtn.textContent = `Show Grayscale: ${gameOptions.isGrayscale ? 'ON' : 'OFF'}`;

            // Hard Mode
            const hardBtn = document.getElementById('toggle-hardmode');
            hardBtn.className = `toggle-btn py-2 px-3 rounded ${gameOptions.isHardMode ? 'active bg-red-800 border-red-500' : ''}`;
            hardBtn.textContent = `Hard Mode: ${gameOptions.isHardMode ? 'ON' : 'OFF'}`;

            // Skill Types
            document.getElementById('toggle-icon').classList.toggle('active', gameOptions.activeSkillTypes.icon);
            document.getElementById('toggle-1st').classList.toggle('active', gameOptions.activeSkillTypes['1st']);
            document.getElementById('toggle-ss').classList.toggle('active', gameOptions.activeSkillTypes.ss);
            document.getElementById('toggle-series').classList.toggle('active', gameOptions.activeSkillTypes.series);
        }


        // --- GAME LOOP ENGINE ---
        window.toggleAuto = () => {
            isRunning = !isRunning;
            const btn = document.getElementById('btn-auto');
            
            if(isRunning) {
                btn.innerHTML = "‚èπ STOP AUTO-LOOP";
                btn.className = "w-full bg-red-900 text-white font-bold py-6 rounded hover:bg-red-800 text-2xl mb-6 border border-red-500 animate-pulse shadow-[0_0_20px_red]";
                runGameSequence();
            } else {
                btn.innerHTML = "‚ñ∂ START AUTO-LOOP";
                btn.className = "w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all shadow-lg";
                stopGameSequence();
            }
        };

        async function runGameSequence() {
            if(!isRunning) return;

            const GAME_TIME = 20; 
            const IDLE_TIME = 5;  
            
            // 1. Filter HERO_POOL based on activeSkillTypes
            const filteredPool = HERO_POOL.filter(hero => {
                if (gameOptions.activeSkillTypes.icon && hero.type === 'icon') return true;
                if (gameOptions.activeSkillTypes['1st'] && hero.type === '1st') return true;
                if (gameOptions.activeSkillTypes.ss && hero.type === 'ss') return true;
                if (gameOptions.activeSkillTypes.series && hero.isSeries) return true; // Check if it's a series skin
                return false;
            });

            if (filteredPool.length === 0) {
                updateStatus("ERROR", "No heroes match current filter!", "text-red-500");
                stopGameSequence();
                return;
            }

            // 2. Pick Random from filtered pool
            const data = filteredPool[Math.floor(Math.random() * filteredPool.length)];
            const roundId = Date.now();

            // 3. START ROUND
            updateStatus("ROUND ACTIVE", `Hero: ${data.name} (${data.type})`, "text-green-500");
            
            await set(ref(db, 'gameState'), {
                phase: 'playing',
                currentHero: data.name,
                imgUrl: data.img,
                isGrayscale: gameOptions.isGrayscale, // Pass grayscale option
                isHardMode: gameOptions.isHardMode,   // Pass hard mode option
                isSeriesSkin: data.isSeries,          // Pass if it's a series skin
                roundId: roundId
            });

            await set(ref(db, 'timer'), {
                endTime: Date.now() + (GAME_TIME * 1000),
                duration: GAME_TIME
            });

            await startCountdown(GAME_TIME);

            // 4. END ROUND
            if(!isRunning) return;
            updateStatus("ROUND ENDED", `Answer: ${data.name}`, "text-yellow-500");

            await set(ref(db, 'gameState'), {
                phase: 'ended',
                currentHero: data.name,
                imgUrl: data.img,
                isGrayscale: false, // Always color reveal on end
                isHardMode: false,  // Hard mode always off on end
                isSeriesSkin: data.isSeries, // Retain for styling post-reveal
                roundId: 0
            });

            await startCountdown(IDLE_TIME);

            // 5. NEXT
            runGameSequence();
        }

        function stopGameSequence() {
            clearTimeout(loopTimer);
            clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = "";
            updateStatus("SYSTEM STOPPED", "Click Start to resume", "text-white");
        }

        window.skipRound = () => {
            if(isRunning) {
                stopGameSequence();
                setTimeout(() => { isRunning = true; runGameSequence(); }, 500);
            }
        };

        function startCountdown(seconds) {
            return new Promise(resolve => {
                let s = seconds;
                document.getElementById('countdown').textContent = s;
                
                countdownInterval = setInterval(() => {
                    s--;
                    document.getElementById('countdown').textContent = s;
                    if(s <= 0) {
                        clearInterval(countdownInterval);
                        resolve();
                    }
                }, 1000);
                loopTimer = setTimeout(() => { clearInterval(countdownInterval); }, seconds * 1000);
            });
        }

        function updateStatus(title, detail, colorClass) {
            document.getElementById('status-title').textContent = title;
            const d = document.getElementById('status-detail');
            d.textContent = detail;
            d.className = colorClass;
        }

        window.resetData = () => {
            if(confirm("‚ö† RESET ALL SCORES?")) {
                set(ref(db, 'scores'), {});
                set(ref(db, 'roundWinners'), {});
            }
        };
    </script>
</body>
</html>
