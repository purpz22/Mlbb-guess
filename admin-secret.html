<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Engine (Host)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body{background:#000; color:#0f0; font-family: monospace; padding: 20px;}</style>
</head>
<body>
    <div class="max-w-2xl mx-auto border border-green-900 p-6 rounded bg-gray-900">
        <h1 class="text-3xl font-bold mb-4">SERVER CONTROL</h1>
        
        <div id="status" class="bg-black p-4 mb-4 text-center border border-green-500 text-xl">
            SYSTEM STANDBY
        </div>

        <button id="btn-auto" onclick="toggleAuto()" class="w-full bg-green-700 text-white font-bold py-4 rounded hover:bg-green-600 text-xl mb-4">
            ▶ ENABLE AUTO-LOOP
        </button>

        <div class="text-xs text-gray-500 text-center">
            ⚠️ DO NOT CLOSE THIS TAB WHILE GAME IS RUNNING ⚠️<br>
            This page acts as the Game Server.
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-800 flex justify-between">
             <button onclick="resetData()" class="text-red-500 underline">Reset All Scores</button>
             <div id="countdown"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ✅ YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- HERO DATA ---
        // ADD MORE HERE!
        const LIBRARY = [
            { name: "Layla", img: "https://res.cloudinary.com/drlx52x1o/image/upload/v1706692823/layla-icon_v1.webp" },
            { name: "Gusion", img: "https://res.cloudinary.com/drlx52x1o/image/upload/v1706692823/gusion-kof.jpg" },
            { name: "Chou", img: "https://res.cloudinary.com/drlx52x1o/image/upload/v1706692823/chou-stun.jpg" },
            { name: "Fanny", img: "https://res.cloudinary.com/drlx52x1o/image/upload/v1706692823/fanny-skylark.jpg" },
            { name: "Alucard", img: "https://res.cloudinary.com/drlx52x1o/image/upload/v1706692823/alucard-legend.jpg" }
        ];

        // --- LOGIC ---
        let isRunning = false;
        let loopTimeout;

        window.toggleAuto = () => {
            isRunning = !isRunning;
            const btn = document.getElementById('btn-auto');
            const status = document.getElementById('status');

            if(isRunning) {
                btn.textContent = "⏹ STOP AUTO-LOOP";
                btn.classList.replace('bg-green-700', 'bg-red-700');
                status.textContent = "server: RUNNING...";
                runGameLoop();
            } else {
                btn.textContent = "▶ ENABLE AUTO-LOOP";
                btn.classList.replace('bg-red-700', 'bg-green-700');
                status.textContent = "server: STOPPED";
                clearTimeout(loopTimeout);
            }
        };

        async function runGameLoop() {
            if(!isRunning) return;

            // 1. Pick Random Hero
            const hero = LIBRARY[Math.floor(Math.random() * LIBRARY.length)];
            const roundId = Date.now();
            const GAME_DURATION = 15; // Seconds to guess
            const COOLDOWN = 5;      // Seconds between rounds

            // 2. START ROUND (Write to DB)
            document.getElementById('status').textContent = `>>> ROUND START: ${hero.name}`;
            await set(ref(db, 'gameState'), {
                phase: 'playing',
                currentHero: hero.name,
                imgUrl: hero.img,
                isGrayscale: true,
                roundId: roundId
            });
            await set(ref(db, 'timer'), {
                endTime: Date.now() + (GAME_DURATION * 1000),
                duration: GAME_DURATION
            });

            // 3. Wait for game to finish
            updateCountdown(GAME_DURATION, "GUESSING...");
            await wait(GAME_DURATION * 1000);

            // 4. END ROUND (Write to DB)
            if(!isRunning) return;
            document.getElementById('status').textContent = `<<< ROUND END: ${hero.name}`;
            await set(ref(db, 'gameState'), {
                phase: 'ended',
                currentHero: hero.name,
                imgUrl: hero.img, // Keep image
                isGrayscale: false, // Colorize
                roundId: 0
            });

            // 5. Wait Cooldown
            updateCountdown(COOLDOWN, "NEXT ROUND IN...");
            await wait(COOLDOWN * 1000);

            // 6. Repeat
            runGameLoop();
        }

        function wait(ms) {
            return new Promise(resolve => {
                loopTimeout = setTimeout(resolve, ms);
            });
        }

        function updateCountdown(seconds, text) {
            let s = seconds;
            const el = document.getElementById('countdown');
            const int = setInterval(() => {
                el.textContent = `${text} ${s}s`;
                s--;
                if(s < 0) clearInterval(int);
            }, 1000);
        }

        window.resetData = () => {
            if(confirm("Reset scores?")) {
                set(ref(db, 'scores'), {});
                set(ref(db, 'roundWinners'), {});
            }
        }
    </script>
</body>
</html>
