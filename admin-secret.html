<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .hidden { display: none !important; }
        .scan-line { width: 100%; height: 2px; background: rgba(0,255,0,0.3); position: absolute; animation: scan 3s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        /* Checkbox Styling */
        input[type="checkbox"] {
            appearance: none;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            border: 2px solid #10b981; /* green-500 */
            border-radius: 0.25rem; /* 4px */
            background-color: #0f0f0f; /* darker background */
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            transition: background-color 0.2s, border-color 0.2s;
        }

        input[type="checkbox"]:checked {
            background-color: #10b981; /* green-500 */
            border-color: #10b981;
        }

        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0.35rem; /* 7px */
            height: 0.7rem; /* 14px */
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -50%) rotate(45deg);
        }
    </style>
</head>
<body class="relative overflow-hidden">
    <div class="scan-line"></div>

    <!-- üîí 1. LOCK SCREEN -->
    <div id="login-screen" class="w-full max-w-md border border-green-800 p-8 bg-black rounded shadow-[0_0_30px_rgba(0,255,0,0.1)] text-center">
        <h1 class="text-3xl font-bold mb-6 text-red-500 tracking-widest">RESTRICTED ACCESS</h1>
        <div class="mb-4 text-xs text-gray-500">AUTHENTICATION REQUIRED</div>
        
        <input type="password" id="password-input" 
            class="w-full bg-gray-900 border border-green-700 p-4 text-center text-white text-xl outline-none focus:border-green-400 mb-4 rounded" 
            placeholder="ENTER PASSWORD">
        
        <button onclick="attemptLogin()" 
            class="w-full bg-green-900 hover:bg-green-700 text-white font-bold py-3 rounded border border-green-600 transition-all">
            UNLOCK CONSOLE
        </button>
        <div id="login-msg" class="text-red-500 mt-4 text-sm min-h-[20px]"></div>
    </div>

    <!-- üéõÔ∏è 2. CONTROL PANEL (Hidden by default) -->
    <div id="control-panel" class="hidden w-full max-w-3xl border border-green-900 p-6 rounded bg-gray-900 shadow-2xl">
        <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white">SERVER CONTROL</h1>
                <div class="text-gray-500 text-xs mt-1">Database: Asia-Southeast1 (Connected)</div>
            </div>
            <div class="text-xs text-green-500 border border-green-500 px-2 py-1 rounded">ADMIN ACTIVE</div>
        </div>
        
        <!-- STATUS BOX -->
        <div id="status-box" class="bg-black p-6 mb-6 text-center border-2 border-green-600 rounded-lg shadow-[0_0_20px_rgba(0,255,0,0.2)]">
            <h2 id="status-title" class="text-2xl font-bold text-white mb-2">SYSTEM STANDBY</h2>
            <div id="status-detail" class="text-green-400">Waiting for command...</div>
            <div id="countdown" class="text-4xl font-bold text-yellow-500 mt-4 h-10"></div>
        </div>

        <!-- CONTROLS -->
        <button id="btn-auto" onclick="toggleAuto()" class="w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all shadow-lg">
            ‚ñ∂ START AUTO-LOOP
        </button>

        <!-- GAME OPTIONS -->
        <div class="mb-6 p-4 bg-gray-800 rounded border border-gray-700">
            <h3 class="text-lg font-bold text-blue-400 mb-3">Game Options</h3>
            <div class="flex flex-wrap gap-x-6 gap-y-2">
                <!-- Grayscale Toggle -->
                <label class="flex items-center text-gray-300 cursor-pointer">
                    <input type="checkbox" id="opt-grayscale" checked onchange="updateAdminSettings()">
                    <span>Grayscale Image</span>
                </label>
            </div>
            <div class="mt-4 border-t border-gray-700 pt-4">
                <h4 class="text-md font-bold text-green-400 mb-2">Hero Image Types:</h4>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-2">
                    <label class="flex items-center text-gray-300 cursor-pointer">
                        <input type="checkbox" id="opt-icon" checked onchange="updateAdminSettings()">
                        <span>Icons</span>
                    </label>
                    <label class="flex items-center text-gray-300 cursor-pointer">
                        <input type="checkbox" id="opt-1st" onchange="updateAdminSettings()">
                        <span>1st Skill</span>
                    </label>
                    <label class="flex items-center text-gray-300 cursor-pointer">
                        <input type="checkbox" id="opt-ss" onchange="updateAdminSettings()">
                        <span>Ultimate (SS)</span>
                    </label>
                    <label class="flex items-center text-gray-300 cursor-pointer">
                        <input type="checkbox" id="opt-series" onchange="updateAdminSettings()">
                        <span>Series Skins</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
             <button onclick="skipRound()" class="bg-yellow-900/40 text-yellow-200 border border-yellow-700 py-3 rounded hover:bg-yellow-900/80 transition shadow">Skip / Force Next</button>
             <button onclick="resetData()" class="bg-red-900/40 text-red-200 border border-red-700 py-3 rounded hover:bg-red-900/80 transition shadow">Reset Leaderboard</button>
        </div>

        <!-- LOGS -->
        <div class="mt-6 pt-4 border-t border-gray-800">
            <div class="text-xs text-gray-500 mb-2">ASSET LIBRARY STATUS:</div>
            <div id="library-count" class="text-white font-bold animate-pulse">Initializing...</div>
            <div class="text-xs text-gray-600 mt-4">
                ‚ö†Ô∏è KEEP THIS TAB OPEN. This page is the "Brain" of the game.
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‚úÖ YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        // --- AUTHENTICATION LOGIC ---
        const ADMIN_PASSWORD = "admin123"; // üîë CHANGE THIS PASSWORD!
        
        window.attemptLogin = function() {
            const pass = document.getElementById('password-input').value;
            const msg = document.getElementById('login-msg');
            
            if(pass === ADMIN_PASSWORD) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('control-panel').classList.remove('hidden');
                initApp(); // Initialize Firebase and game logic AFTER login
            } else {
                msg.textContent = "ACCESS DENIED: INVALID PASSWORD";
                document.getElementById('password-input').value = "";
                document.getElementById('password-input').classList.add('border-red-500');
                setTimeout(() => {
                    msg.textContent = "";
                    document.getElementById('password-input').classList.remove('border-red-500');
                }, 2000);
            }
        };
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') attemptLogin();
        });


        // --- FIREBASE & GAME LOGIC ---
        let app, db;
        let HERO_POOL = []; // All possible assets
        let adminSettings = {
            grayscale: true,
            selectedSkillTypes: new Set(['icon']) // Default: only icons
        };

        function initApp() {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            generateAssets();
            updateAdminSettings(); // Initial update based on checkbox state
        }

        function normalizeName(name) {
            return name.toLowerCase().replace(/[' .]/g, '-').replace(/\.+$/, '');
        }

        const uniqueHeroNames = new Set([
            "Lunox", "Luo Yi", "Zhuxin", "Chip", "Cici", "Nolan", "Arlott", "Novaria", "Joy", "Fredrinn", 
            "Julian", "Xavier", "Melissa", "Yin", "Floryn", "Edith", "Valentina", "Aamon", "Aulus", "Natan", 
            "Phoveus", "Beatrix", "Gloo", "Paquito", "Mathilda", "Yve", "Brody", "Barats", "Khaleed", "Benedetta", 
            "Atlas", "Carmilla", "Cecilion", "Silvanna", "Wanwan", "Masha", "Baxia", "Ling", "X.borg", "Terizla", 
            "Esmeralda", "Guinevere", "Granger", "Khufra", "Badang", "Faramis", "Kadita", "Minotaur", "Hanzo", 
            "Claude", "Aldous", "Selena", "Kaja", "Chang'e", "Thamuz", "Kimmy", "Belerick", "Leomord", "Vale", 
            "Hanabi", "Uranus", "Martis", "Valir", "Gusion", "Angela", "Jawhead", "Lesley", "Pharsa", "Helcurt", 
            "Zhask", "Hylos", "Diggie", "Lancelot", "Odette", "Argus", "Grock", "Irithel", "Harley", "Gatotkaca", 
            "Roger", "Vexana", "Lapu-Lapu", "Aurora", "Hilda", "Estes", "Cyclops", "Johnson", "Moskov", 
            "Yi Sun shin", "Ruby", "Alpha", "Sun", "Chou", "Kagura", "Natalia", "Gord", "Freya", "Hayabusa", 
            "Lolita", "Layla", "Zilong", "Eudora", "Rafaela", "Clint", "Bruno", "Bane", "Franco", "Akai", "Karina", 
            "Alucard", "Miya", "Saber", "Balmond", "Nana", "Alice", "Zetian"
        ]);

        const predefinedSeriesSkins = [
            { "name": "Chou", "skill_type": "kof1", "icon_path": "icons/chou-kof1.png" },
            { "name": "Gusion", "skill_type": "kof2", "icon_path": "icons/gusion-KOF2.png" },
            // Add more series skins here as needed (e.g., V.E.N.O.M. Gusion, S.A.B.E.R. Layla)
            // { "name": "Gusion", "skill_type": "V.E.N.O.M", "icon_path": "icons/gusion-venom.png" },
            // { "name": "Layla", "skill_type": "S.A.B.E.R", "icon_path": "icons/layla-saber.png" }
        ];

        // List of all known series skin types (used for toggling them all)
        const allSkinSeriesTypes = [
            "kof1", "kof2", "kof3", "V.E.N.O.M", "attack-on-titan", "hunterxhunter", "11.11skin", 
            "PRIME", "abyss", "lightborn", "dragon-tamer", "zodiac", "ducati", "transformers", 
            "sanrio", "starwars", "naruto", "blazing-bounties", "dawning-stars", "exorcists", 
            "the-aspirants", "halloween", "summer", "mpl", "kung-fu-panda", "christmas", 
            "valentine", "legends-skin", "neobeasts", "jujutsu-kaisen", "saint-seiya", "lunar-fest", 
            "champion", "M-WORLD", "s.a.b.e.r", "epic", "special" 
        ];


        function generateAssets() {
            HERO_POOL = [];
            
            uniqueHeroNames.forEach(heroName => {
                if (heroName === "Fanny") return;
                const baseName = normalizeName(heroName);
                
                // Add Ultimate (SS)
                HERO_POOL.push({ name: heroName, skill_type: "ss", img: `icons/${baseName}-ss.webp` });
                // Add 1st Skill
                HERO_POOL.push({ name: heroName, skill_type: "1st", img: `icons/${baseName}-1st.png` });
                // Add Icon
                HERO_POOL.push({ name: heroName, skill_type: "icon", img: `icons/${baseName}-icon.webp` });
            });

            // Add Predefined Series Skins
            predefinedSeriesSkins.forEach(skin => {
                HERO_POOL.push({ name: skin.name, skill_type: skin.skill_type, img: skin.icon_path });
            });

            document.getElementById('library-count').textContent = `Loaded ${HERO_POOL.length} unique assets.`;
            document.getElementById('library-count').classList.remove('animate-pulse');
        }

        // --- ADMIN OPTIONS HANDLER ---
        window.updateAdminSettings = () => {
            adminSettings.grayscale = document.getElementById('opt-grayscale').checked;
            
            // Clear and rebuild selected skill types
            adminSettings.selectedSkillTypes.clear();
            if (document.getElementById('opt-icon').checked) adminSettings.selectedSkillTypes.add('icon');
            if (document.getElementById('opt-1st').checked) adminSettings.selectedSkillTypes.add('1st');
            if (document.getElementById('opt-ss').checked) adminSettings.selectedSkillTypes.add('ss');
            
            // Handle 'Series Skins' special case
            if (document.getElementById('opt-series').checked) {
                allSkinSeriesTypes.forEach(type => adminSettings.selectedSkillTypes.add(type));
            }

            if (adminSettings.selectedSkillTypes.size === 0) {
                // Prevent empty pool: if nothing selected, default to icons
                adminSettings.selectedSkillTypes.add('icon');
                document.getElementById('opt-icon').checked = true;
            }
            // console.log("Admin Settings Updated:", adminSettings);
        };

        // --- GAME LOOP ENGINE ---
        let isRunning = false;
        let loopTimer;
        let countdownInterval;

        window.toggleAuto = () => {
            isRunning = !isRunning;
            const btn = document.getElementById('btn-auto');
            
            if(isRunning) {
                btn.innerHTML = "‚èπ STOP AUTO-LOOP";
                btn.className = "w-full bg-red-900 text-white font-bold py-6 rounded hover:bg-red-800 text-2xl mb-6 border border-red-500 animate-pulse shadow-[0_0_20px_red]";
                runGameSequence();
            } else {
                btn.innerHTML = "‚ñ∂ START AUTO-LOOP";
                btn.className = "w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all shadow-lg";
                stopGameSequence();
            }
        };

        async function runGameSequence() {
            if(!isRunning) return;

            const GAME_TIME = 20; 
            const IDLE_TIME = 5;  
            
            // 1. Filter HERO_POOL based on selected types
            const filteredPool = HERO_POOL.filter(hero => adminSettings.selectedSkillTypes.has(hero.skill_type));
            
            if (filteredPool.length === 0) {
                updateStatus("ERROR", "No heroes match selected filters!", "text-red-500");
                stopGameSequence();
                return;
            }

            // 2. Pick Random from filtered pool
            const data = filteredPool[Math.floor(Math.random() * filteredPool.length)];
            const roundId = Date.now();

            // 3. START ROUND
            updateStatus("ROUND ACTIVE", `Hero: ${data.name} (${data.skill_type})`, "text-green-500");
            
            await set(ref(db, 'gameState'), {
                phase: 'playing',
                currentHero: data.name,
                imgUrl: data.img,
                isGrayscale: adminSettings.grayscale, // Use admin setting
                roundId: roundId
            });

            await set(ref(db, 'timer'), {
                endTime: Date.now() + (GAME_TIME * 1000),
                duration: GAME_TIME
            });

            await startCountdown(GAME_TIME);

            // 4. END ROUND
            if(!isRunning) return;
            updateStatus("ROUND ENDED", `Answer: ${data.name}`, "text-yellow-500");

            await set(ref(db, 'gameState'), {
                phase: 'ended',
                currentHero: data.name,
                imgUrl: data.img,
                isGrayscale: false, // Always color reveal
                roundId: 0
            });

            await startCountdown(IDLE_TIME);

            // 5. NEXT
            runGameSequence();
        }

        function stopGameSequence() {
            clearTimeout(loopTimer);
            clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = "";
            updateStatus("SYSTEM STOPPED", "Click Start to resume", "text-white");
        }

        window.skipRound = () => {
            if(isRunning) {
                stopGameSequence();
                setTimeout(() => { isRunning = true; runGameSequence(); }, 500);
            }
        };

        function startCountdown(seconds) {
            return new Promise(resolve => {
                let s = seconds;
                document.getElementById('countdown').textContent = s;
                
                countdownInterval = setInterval(() => {
                    s--;
                    document.getElementById('countdown').textContent = s;
                    if(s <= 0) {
                        clearInterval(countdownInterval);
                        resolve();
                    }
                }, 1000);
                loopTimer = setTimeout(() => { clearInterval(countdownInterval); }, seconds * 1000); // Safety
            });
        }

        function updateStatus(title, detail, colorClass) {
            document.getElementById('status-title').textContent = title;
            const d = document.getElementById('status-detail');
            d.textContent = detail;
            d.className = colorClass;
        }

        window.resetData = () => {
            if(confirm("‚ö† RESET ALL SCORES? This cannot be undone.")) {
                set(ref(db, 'scores'), {});
                set(ref(db, 'roundWinners'), {});
                // Also reset gameState to 'waiting'
                set(ref(db, 'gameState'), { phase: 'waiting', currentHero: '', imgUrl: 'https://placehold.co/200x200/222/fff?text=LOADING...' });
                set(ref(db, 'timer'), { endTime: Date.now(), duration: 0 });
            }
        };
    </script>
</body>
</html>
