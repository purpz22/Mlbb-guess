<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .hidden { display: none !important; }
        .scan-line { width: 100%; height: 2px; background: rgba(0,255,0,0.3); position: absolute; animation: scan 3s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
    </style>
</head>
<body class="relative overflow-hidden">
    <div class="scan-line"></div>

    <!-- üîí 1. LOCK SCREEN -->
    <div id="login-screen" class="w-full max-w-md border border-green-800 p-8 bg-black rounded shadow-[0_0_30px_rgba(0,255,0,0.1)] text-center">
        <h1 class="text-3xl font-bold mb-6 text-red-500 tracking-widest">RESTRICTED ACCESS</h1>
        <div class="mb-4 text-xs text-gray-500">AUTHENTICATION REQUIRED</div>
        
        <input type="password" id="password-input" 
            class="w-full bg-gray-900 border border-green-700 p-4 text-center text-white text-xl outline-none focus:border-green-400 mb-4 rounded" 
            placeholder="ENTER PASSWORD">
        
        <button onclick="attemptLogin()" 
            class="w-full bg-green-900 hover:bg-green-700 text-white font-bold py-3 rounded border border-green-600 transition-all">
            UNLOCK CONSOLE
        </button>
        <div id="login-msg" class="text-red-500 mt-4 text-sm min-h-[20px]"></div>
    </div>

    <!-- üéõÔ∏è 2. CONTROL PANEL (Hidden by default) -->
    <div id="control-panel" class="hidden w-full max-w-3xl border border-green-900 p-6 rounded bg-gray-900 shadow-2xl">
        <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white">SERVER CONTROL</h1>
                <div class="text-gray-500 text-xs mt-1">Database: Asia-Southeast1 (Connected)</div>
            </div>
            <div class="text-xs text-green-500 border border-green-500 px-2 py-1 rounded">ADMIN ACTIVE</div>
        </div>
        
        <!-- STATUS BOX -->
        <div id="status-box" class="bg-black p-6 mb-6 text-center border-2 border-green-600 rounded-lg shadow-[0_0_20px_rgba(0,255,0,0.2)]">
            <h2 id="status-title" class="text-2xl font-bold text-white mb-2">SYSTEM STANDBY</h2>
            <div id="status-detail" class="text-green-400">Waiting for command...</div>
            <div id="countdown" class="text-4xl font-bold text-yellow-500 mt-4 h-10"></div>
        </div>

        <!-- CONTROLS -->
        <button id="btn-auto" onclick="toggleAuto()" class="w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all shadow-lg">
            ‚ñ∂ START AUTO-LOOP
        </button>

        <div class="grid grid-cols-2 gap-4">
             <button onclick="skipRound()" class="bg-yellow-900/40 text-yellow-200 border border-yellow-700 py-3 rounded hover:bg-yellow-900/80 transition">Skip / Force Next</button>
             <button onclick="resetData()" class="bg-red-900/40 text-red-200 border border-red-700 py-3 rounded hover:bg-red-900/80 transition">Reset Leaderboard</button>
        </div>

        <!-- LOGS -->
        <div class="mt-6 pt-4 border-t border-gray-800">
            <div class="text-xs text-gray-500 mb-2">ASSET LIBRARY STATUS:</div>
            <div id="library-count" class="text-white font-bold animate-pulse">Initializing...</div>
            <div class="text-xs text-gray-600 mt-4">
                ‚ö†Ô∏è KEEP THIS TAB OPEN. This page is the "Brain" of the game.
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‚úÖ YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        // --- AUTHENTICATION LOGIC ---
        window.attemptLogin = function() {
            const pass = document.getElementById('password-input').value;
            const msg = document.getElementById('login-msg');
            
            // üîë PASSWORD SETTING
            if(pass === "admin123") {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('control-panel').classList.remove('hidden');
                // Init Firebase only after login
                initApp();
            } else {
                msg.textContent = "ACCESS DENIED: INVALID PASSWORD";
                document.getElementById('password-input').value = "";
                document.getElementById('password-input').classList.add('border-red-500');
                setTimeout(() => {
                    msg.textContent = "";
                    document.getElementById('password-input').classList.remove('border-red-500');
                }, 2000);
            }
        };
        // Allow Enter key on password
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') attemptLogin();
        });


        // --- FIREBASE & GAME LOGIC (Wrapped in function) ---
        let app, db;
        let HERO_POOL = [];

        function initApp() {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            generateAssets();
        }

        function normalizeName(name) {
            return name.toLowerCase().replace(/[' .]/g, '-').replace(/\.+$/, '');
        }

        const uniqueHeroNames = new Set([
            "Lunox", "Luo Yi", "Zhuxin", "Chip", "Cici", "Nolan", "Arlott", "Novaria", "Joy", "Fredrinn", 
            "Julian", "Xavier", "Melissa", "Yin", "Floryn", "Edith", "Valentina", "Aamon", "Aulus", "Natan", 
            "Phoveus", "Beatrix", "Gloo", "Paquito", "Mathilda", "Yve", "Brody", "Barats", "Khaleed", "Benedetta", 
            "Atlas", "Carmilla", "Cecilion", "Silvanna", "Wanwan", "Masha", "Baxia", "Ling", "X.borg", "Terizla", 
            "Esmeralda", "Guinevere", "Granger", "Khufra", "Badang", "Faramis", "Kadita", "Minotaur", "Hanzo", 
            "Claude", "Aldous", "Selena", "Kaja", "Chang'e", "Thamuz", "Kimmy", "Belerick", "Leomord", "Vale", 
            "Hanabi", "Uranus", "Martis", "Valir", "Gusion", "Angela", "Jawhead", "Lesley", "Pharsa", "Helcurt", 
            "Zhask", "Hylos", "Diggie", "Lancelot", "Odette", "Argus", "Grock", "Irithel", "Harley", "Gatotkaca", 
            "Roger", "Vexana", "Lapu-Lapu", "Aurora", "Hilda", "Estes", "Cyclops", "Johnson", "Moskov", 
            "Yi Sun shin", "Ruby", "Alpha", "Sun", "Chou", "Kagura", "Natalia", "Gord", "Freya", "Hayabusa", 
            "Lolita", "Layla", "Zilong", "Eudora", "Rafaela", "Clint", "Bruno", "Bane", "Franco", "Akai", "Karina", 
            "Alucard", "Miya", "Saber", "Balmond", "Nana", "Alice", "Zetian"
        ]);

        const predefinedSeriesSkins = [
            { "name": "Chou", "skill_type": "kof1", "icon_path": "icons/chou-kof1.png" },
            { "name": "Gusion", "skill_type": "kof2", "icon_path": "icons/gusion-KOF2.png" }
        ];

        function generateAssets() {
            HERO_POOL = [];
            
            uniqueHeroNames.forEach(heroName => {
                if (heroName === "Fanny") return;
                const baseName = normalizeName(heroName);
                
                HERO_POOL.push({ name: heroName, skill_type: "ss", img: `icons/${baseName}-ss.webp` });
                HERO_POOL.push({ name: heroName, skill_type: "1st", img: `icons/${baseName}-1st.png` });
                HERO_POOL.push({ name: heroName, skill_type: "icon", img: `icons/${baseName}-icon.webp` });
            });

            predefinedSeriesSkins.forEach(skin => {
                HERO_POOL.push({ name: skin.name, skill_type: skin.skill_type, img: skin.icon_path });
            });

            document.getElementById('library-count').textContent = `Loaded ${HERO_POOL.length} images into memory.`;
            document.getElementById('library-count').classList.remove('animate-pulse');
        }

        // --- GAME LOOP ENGINE ---
        let isRunning = false;
        let loopTimer;
        let countdownInterval;

        window.toggleAuto = () => {
            isRunning = !isRunning;
            const btn = document.getElementById('btn-auto');
            
            if(isRunning) {
                btn.innerHTML = "‚èπ STOP AUTO-LOOP";
                btn.className = "w-full bg-red-900 text-white font-bold py-6 rounded hover:bg-red-800 text-2xl mb-6 border border-red-500 animate-pulse shadow-[0_0_20px_red]";
                runGameSequence();
            } else {
                btn.innerHTML = "‚ñ∂ START AUTO-LOOP";
                btn.className = "w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all shadow-lg";
                stopGameSequence();
            }
        };

        async function runGameSequence() {
            if(!isRunning) return;

            const GAME_TIME = 20; 
            const IDLE_TIME = 5;  
            
            // 1. Pick Random
            const data = HERO_POOL[Math.floor(Math.random() * HERO_POOL.length)];
            const roundId = Date.now();

            // 2. START ROUND
            updateStatus("ROUND ACTIVE", `Hero: ${data.name} (${data.skill_type})`, "text-green-500");
            
            await set(ref(db, 'gameState'), {
                phase: 'playing',
                currentHero: data.name,
                imgUrl: data.img,
                isGrayscale: true,
                roundId: roundId
            });

            await set(ref(db, 'timer'), {
                endTime: Date.now() + (GAME_TIME * 1000),
                duration: GAME_TIME
            });

            await startCountdown(GAME_TIME);

            // 3. END ROUND
            if(!isRunning) return;
            updateStatus("ROUND ENDED", `Answer: ${data.name}`, "text-yellow-500");

            await set(ref(db, 'gameState'), {
                phase: 'ended',
                currentHero: data.name,
                imgUrl: data.img,
                isGrayscale: false,
                roundId: 0
            });

            await startCountdown(IDLE_TIME);

            // 4. NEXT
            runGameSequence();
        }

        function stopGameSequence() {
            clearTimeout(loopTimer);
            clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = "";
            updateStatus("SYSTEM STOPPED", "Click Start to resume", "text-white");
        }

        window.skipRound = () => {
            if(isRunning) {
                stopGameSequence();
                setTimeout(() => { isRunning = true; runGameSequence(); }, 500);
            }
        };

        function startCountdown(seconds) {
            return new Promise(resolve => {
                let s = seconds;
                document.getElementById('countdown').textContent = s;
                
                countdownInterval = setInterval(() => {
                    s--;
                    document.getElementById('countdown').textContent = s;
                    if(s <= 0) {
                        clearInterval(countdownInterval);
                        resolve();
                    }
                }, 1000);
                loopTimer = setTimeout(() => { clearInterval(countdownInterval); }, seconds * 1000);
            });
        }

        function updateStatus(title, detail, colorClass) {
            document.getElementById('status-title').textContent = title;
            const d = document.getElementById('status-detail');
            d.textContent = detail;
            d.className = colorClass;
        }

        window.resetData = () => {
            if(confirm("‚ö† RESET ALL SCORES?")) {
                set(ref(db, 'scores'), {});
                set(ref(db, 'roundWinners'), {});
            }
        };
    </script>
</body>
</html>
