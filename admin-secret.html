<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .hidden { display: none !important; }
        .scan-line { width: 100%; height: 2px; background: rgba(0,255,0,0.3); position: absolute; animation: scan 3s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
    </style>
</head>
<body class="relative overflow-hidden">
    <div class="scan-line"></div>

    <!-- LOCK SCREEN -->
    <div id="login-screen" class="w-full max-w-md border border-green-800 p-8 bg-black rounded shadow-[0_0_30px_rgba(0,255,0,0.1)] text-center">
        <h1 class="text-3xl font-bold mb-6 text-red-500 tracking-widest">RESTRICTED ACCESS</h1>
        <input type="password" id="password-input" class="w-full bg-gray-900 border border-green-700 p-4 text-center text-white text-xl outline-none focus:border-green-400 mb-4 rounded" placeholder="ENTER PASSWORD">
        <button onclick="attemptLogin()" class="w-full bg-green-900 hover:bg-green-700 text-white font-bold py-3 rounded border border-green-600 transition-all">UNLOCK CONSOLE</button>
        <div id="login-msg" class="text-red-500 mt-4 text-sm min-h-[20px]"></div>
    </div>

    <!-- CONTROL PANEL -->
    <div id="control-panel" class="hidden w-full max-w-3xl border border-green-900 p-6 rounded bg-gray-900 shadow-2xl">
        <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
            <h1 class="text-3xl font-bold text-white">SERVER CONTROL</h1>
            <div id="wake-status" class="text-xs text-gray-500 border border-gray-500 px-2 py-1 rounded">Wake Lock: OFF</div>
        </div>
        
        <!-- STATUS -->
        <div id="status-box" class="bg-black p-6 mb-6 text-center border-2 border-green-600 rounded-lg shadow-[0_0_20px_rgba(0,255,0,0.2)]">
            <h2 id="status-title" class="text-2xl font-bold text-white mb-2">SYSTEM STANDBY</h2>
            <div id="status-detail" class="text-green-400">Waiting for command...</div>
            <div id="countdown" class="text-4xl font-bold text-yellow-500 mt-4 h-10"></div>
        </div>

        <!-- CONTROLS -->
        <button id="btn-auto" onclick="toggleAuto()" class="w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all shadow-lg">▶ START AUTO-LOOP</button>

        <div class="grid grid-cols-2 gap-4">
             <button onclick="skipRound()" class="bg-yellow-900/40 text-yellow-200 border border-yellow-700 py-3 rounded">Skip Round</button>
             <button onclick="resetData()" class="bg-red-900/40 text-red-200 border border-red-700 py-3 rounded">Reset Scores</button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-800 text-xs text-gray-500 text-center">
            ⚠️ KEEP THIS TAB VISIBLE & SCREEN ON TO PREVENT FREEZING ⚠️
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ✅ PASTE CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyCPSU7YrNL0M9j0EFUBRHDoufpW9bQlUsI",
            authDomain: "guesshero-e1180.firebaseapp.com",
            databaseURL: "https://guesshero-e1180-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "guesshero-e1180",
            storageBucket: "guesshero-e1180.firebasestorage.app",
            messagingSenderId: "274899168100",
            appId: "1:274899168100:web:da9798cf93110516d8e871"
        };

        let app, db, HERO_POOL = [];
        let wakeLock = null;

        // --- WAKE LOCK (Anti-Freeze) ---
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                document.getElementById('wake-status').textContent = "Wake Lock: ACTIVE ⚡";
                document.getElementById('wake-status').className = "text-xs text-green-500 border border-green-500 px-2 py-1 rounded";
            } catch (err) {
                console.log(`${err.name}, ${err.message}`);
            }
        }

        // --- LOGIN ---
        window.attemptLogin = function() {
            const pass = document.getElementById('password-input').value;
            if(pass === "admin123") {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('control-panel').classList.remove('hidden');
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                generateAssets();
                requestWakeLock(); // Request screen stay on
            } else {
                alert("Wrong Password");
            }
        };

        // --- ASSETS ---
        function normalizeName(name) { return name.toLowerCase().replace(/[' .]/g, '-').replace(/\.+$/, ''); }
        const uniqueHeroNames = new Set([
            "Lunox", "Luo Yi", "Zhuxin", "Chip", "Cici", "Nolan", "Arlott", "Novaria", "Joy", "Fredrinn", 
            "Julian", "Xavier", "Melissa", "Yin", "Floryn", "Edith", "Valentina", "Aamon", "Aulus", "Natan", 
            "Phoveus", "Beatrix", "Gloo", "Paquito", "Mathilda", "Yve", "Brody", "Barats", "Khaleed", "Benedetta", 
            "Atlas", "Carmilla", "Cecilion", "Silvanna", "Wanwan", "Masha", "Baxia", "Ling", "X.borg", "Terizla", 
            "Esmeralda", "Guinevere", "Granger", "Khufra", "Badang", "Faramis", "Kadita", "Minotaur", "Hanzo", 
            "Claude", "Aldous", "Selena", "Kaja", "Chang'e", "Thamuz", "Kimmy", "Belerick", "Leomord", "Vale", 
            "Hanabi", "Uranus", "Martis", "Valir", "Gusion", "Angela", "Jawhead", "Lesley", "Pharsa", "Helcurt", 
            "Zhask", "Hylos", "Diggie", "Lancelot", "Odette", "Argus", "Grock", "Irithel", "Harley", "Gatotkaca", 
            "Roger", "Vexana", "Lapu-Lapu", "Aurora", "Hilda", "Estes", "Cyclops", "Johnson", "Moskov", 
            "Yi Sun shin", "Ruby", "Alpha", "Sun", "Chou", "Kagura", "Natalia", "Gord", "Freya", "Hayabusa", 
            "Lolita", "Layla", "Zilong", "Eudora", "Rafaela", "Clint", "Bruno", "Bane", "Franco", "Akai", "Karina", 
            "Alucard", "Miya", "Saber", "Balmond", "Nana", "Alice", "Zetian"
        ]);

        function generateAssets() {
            HERO_POOL = [];
            uniqueHeroNames.forEach(n => {
                if(n==="Fanny") return;
                const b = normalizeName(n);
                HERO_POOL.push({ name: n, skill_type: "ss", img: `icons/${b}-ss.webp` });
                HERO_POOL.push({ name: n, skill_type: "1st", img: `icons/${b}-1st.png` });
                HERO_POOL.push({ name: n, skill_type: "icon", img: `icons/${b}-icon.webp` });
            });
        }

        // --- ENGINE ---
        let isRunning = false;
        let loopTimeout = null;
        let countdownInt = null;

        window.toggleAuto = () => {
            isRunning = !isRunning;
            const btn = document.getElementById('btn-auto');
            if(isRunning) {
                btn.textContent = "⏹ STOP AUTO-LOOP";
                btn.className = "w-full bg-red-900 text-white font-bold py-6 rounded border border-red-500 animate-pulse text-2xl mb-6";
                runSequence();
            } else {
                btn.textContent = "▶ START AUTO-LOOP";
                btn.className = "w-full bg-green-800 text-white font-bold py-6 rounded hover:bg-green-700 text-2xl mb-6 border border-green-500 transition-all";
                clearTimeout(loopTimeout);
                clearInterval(countdownInt);
                document.getElementById('status-title').textContent = "STOPPED";
                document.getElementById('countdown').textContent = "";
            }
        };

        async function runSequence() {
            if(!isRunning) return;
            const GAME_TIME = 20; 
            const IDLE_TIME = 5;  
            
            // 1. Pick
            const data = HERO_POOL[Math.floor(Math.random() * HERO_POOL.length)];
            const roundId = Date.now();

            // 2. Play
            updateStatus("ROUND ACTIVE", `Hero: ${data.name}`, "text-green-500");
            await set(ref(db, 'gameState'), { phase: 'playing', currentHero: data.name, imgUrl: data.img, isGrayscale: true, roundId: roundId });
            await set(ref(db, 'timer'), { endTime: Date.now() + (GAME_TIME * 1000), duration: GAME_TIME });
            
            await doCountdown(GAME_TIME);

            // 3. End
            if(!isRunning) return;
            updateStatus("ROUND OVER", `Answer: ${data.name}`, "text-yellow-500");
            await set(ref(db, 'gameState'), { phase: 'ended', currentHero: data.name, imgUrl: data.img, isGrayscale: false, roundId: 0 });
            
            await doCountdown(IDLE_TIME);

            // 4. Repeat
            runSequence();
        }

        function doCountdown(sec) {
            return new Promise(resolve => {
                let s = sec;
                document.getElementById('countdown').textContent = s;
                countdownInt = setInterval(() => {
                    s--;
                    document.getElementById('countdown').textContent = s;
                    if(s <= 0) { clearInterval(countdownInt); resolve(); }
                }, 1000);
                // Safety timeout
                loopTimeout = setTimeout(() => { clearInterval(countdownInt); resolve(); }, (sec * 1000) + 500);
            });
        }

        function updateStatus(t, d, c) {
            document.getElementById('status-title').textContent = t;
            const det = document.getElementById('status-detail');
            det.textContent = d;
            det.className = c;
        }

        window.skipRound = () => {
            if(isRunning) {
                clearTimeout(loopTimeout);
                clearInterval(countdownInt);
                runSequence();
            }
        }

        window.resetData = () => {
            if(confirm("Reset Scores?")) {
                set(ref(db, 'scores'), {});
                set(ref(db, 'roundWinners'), {});
            }
        }
    </script>
</body>
</html>
